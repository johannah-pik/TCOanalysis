---
title: "Main plots"
author: "Johanna Hoppe"
date: "2025-02-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)#
library(ggplot2)
library(data.table)
library(RColorBrewer)
library(ggtext)
library(ggh4x)
library(ggforce)
library(patchwork)
library(scales)
library(colorspace)
library(viridisLite)
library(cowplot)
library(funkyheatmap)
library(stringr)
library(grid)
library(tibble)

rm(list=ls())
mainFolder <- dirname(this.path::this.dir())
dataFolder <-  file.path(mainFolder, "data")
plotFolder <- file.path(mainFolder, "plots", "main")
source(file.path(mainFolder, "Plotting scripts", "functions.R"))
source(file.path(mainFolder, "Plotting scripts", "plotFunctions.R"))
source(file.path(mainFolder, "Plotting scripts", "plotSettings.R"))

annualMileage <- data.table(truckClass = c("Rigid", "Rigid", "Rigid", "Tractor-trailer", "Tractor-trailer", "Tractor-trailer"),
                            operation = c("Urban", "Regional", "Long-haul", "Urban", "Regional", "Long-haul"),
                            am = c(30000, 85000, 140000, 40000, 90000, 160000))

DCOscenarios <- tribble(
  ~truckTech,         ~truckTCOscenario, ~counterTech, ~counterTechTCOscenario, ~DCOscenario,
  "BET small battery", "LC_HTMxPROG",    "ICET",       "HC_LTMxBAU",            "Optimistic",
  "BET large battery", "LC_HTMxPROG",    "ICET",       "HC_LTMxBAU",            "Optimistic",
  "FCET",              "LC_HTMxPROG",    "ICET",       "HC_LTMxBAU",            "Optimistic",
  "BET small battery", "MC_MTMxBAU",     "ICET",       "MC_MTMxBAU",            "Medium",
  "BET large battery", "MC_MTMxBAU",     "ICET",       "MC_MTMxBAU",            "Medium",
  "FCET",              "MC_MTMxBAU",     "ICET",       "MC_MTMxBAU",            "Medium",
  "BET small battery", "HC_LTMxBAU",     "ICET",       "LC_HTMxPROG",           "Pessimistic",
  "BET large battery", "HC_LTMxBAU",     "ICET",       "LC_HTMxPROG",           "Pessimistic",
  "FCET",              "HC_LTMxBAU",     "ICET",       "LC_HTMxPROG",           "Pessimistic"
)
setDT(DCOscenarios)
```

# The heterogenous differential cost of ownership of BETs/FCETs against diesel ICETs
## Fig 1
##x Scenario overview
```{r, fig.width=4, fig.height=2.2, fig.fullwidth=FALSE}
scenariosPlot <- scenOverview(baseZise, paperColors)
print(scenariosPlot)
```
### Visualization utilization profiles
```{r, fig.width=3, fig.height=2.2, fig.fullwidth=FALSE}
#load data
reducedBinnedWeightedMileage <- prepareMileageData(dataFolder, bin = TRUE, reduce = TRUE)
exampleCountry <- "DE" 

utilizationExample <- examplaryUtilization(exampleCountry, reducedBinnedWeightedMileage, baseTextSize, themePanel)

grid.newpage()
grid.draw(utilizationExample)

```
### Exemplary TCO barplot
```{r, fig.width=7.05, fig.height=3.5, fig.fullwidth=FALSE}
#select data
paperScenario <- "Current policies"  
yr <- c(2030)
vehSize <- "Tractor-trailer"
modeOfoperation <- "Long-haul"
am <- annualMileage[truckClass == vehSize & operation == modeOfoperation]$am
exampleCountry <- "DE" 
#load data
TCOdata <- loadTCO(dataFolder)
TCO <- applyMileage(am, TCOdata)
TCO <- groupParameters(TCO)

TCOtoDCOexample <- dcoBarPlot(TCO, DCOscenarios, yr, vehSize, exampleCountry, paperScenario)

grid.newpage()
grid.draw(TCOtoDCOexample)

```
### Panel
```{r, fig.width=7.09, fig.height=6.2, fig.fullwidth=FALSE}
gScenarios <- ggplotGrob(scenariosPlot)

row1 <- plot_grid(
  utilizationExample, gScenarios,
  ncol = 2,
  rel_widths = c(3, 3.5)
)

row2 <- plot_grid(
  TCOtoDCOexample,
  ncol = 1
)

whiteSpace <- ggdraw() + theme_void() + 
  theme(plot.background = element_rect(fill = "white", color = NA))

introPanel <- plot_grid(
  whiteSpace,
  row1,
  whiteSpace,
  row2,
  ncol = 1,
  rel_heights = c(0.2, 2, 0.2, 3.5)
)
xMiddle <- 0.485
triangleWidth  <- 0.06      
triangleHeight <- 0.017      
triangleY <- 8.3 / 13

# Create the triangle grob
triangleGrob <- polygonGrob(
  x = c(xMiddle - triangleWidth / 2, xMiddle + triangleWidth / 2, xMiddle),
  y = c(triangleY, triangleY, triangleY - triangleHeight),
  gp = gpar(fill = "black", col = NA, alpha = 0.3)
)

annotatedPanel <- ggdraw(introPanel) +
  draw_label(
    "×",
    x = xMiddle,
    y = 10 / 13,
    size = 20,
    fontface = "bold",
    color = "black",
    alpha = 0.3
  ) +
  draw_grob(triangleGrob) +
  draw_plot_label(
    label = c("a", "b", "c"),
    x = c(0, xMiddle - 0.025, 0),       
    y = c(1, 1, 7.75 / 13 + 0.005),           
    hjust = 0, vjust = 1,
    size = baseTextSize,
    fontface = "bold",
    color = "black"
  ) +
  draw_plot_label(
    label = c(
      "Country- and truck type specific\nutilizaton profiles",
      "Scenario based approach",
      "Country- and truck type specific differential cost of ownership (DCO)"
    ),
    x = c(0.03, xMiddle, 0.03),
    y = c(0.995, 0.995, 7.75 / 13),
    hjust = 0, vjust = 1,
    size = baseTextSize * 1.2,
    fontface = "plain",
    color = "black"
  )

annotatedPanel

ggsave(
  filename = file.path(plotFolder, paste0("introPanel.pdf")),
  plot = annotatedPanel,
  width = 7.1,
  height = 7.4,
  units = "in",
  device = cairo_pdf
)

```

## Fig 2
## TCO x Annual mileage distribution bar plot 
```{r, fig.width= 5, fig.height= 8.5, fig.fullwidth=FALSE}
yr <- c(2030)
paperScenario <- "Current policies"

TCOdata <- loadTCO(dataFolder)
mileageDistribution <- prepareMileageData(dataFolder)
DCOdata <- getDCO(DCOscenarios, TCOdata)
setnames(mileageDistribution, "binMean", "annualM")
DCOmilageDistribution <- applyMileage(mileageDistribution, DCOdata)
DCOmilageDistributionShares <- calculateFreightActivityShares(DCOmilageDistribution, focus = "EUR")
setnames(DCOmilageDistributionShares, "cumBinWeightedShareEUR", "cumShare")

TCOxAnnualMileage <- amDistributionBarPlot(DCOmilageDistributionShares, yr, paperScenario)

MetaTCOxAnnualMileage <- metaPlot(DCOmilageDistributionShares[period < 2041], paperScenario)

```
## Combine meta and mileage dstribution plot
```{r, fig.width=4.5, fig.height=5, fig.fullwidth=FALSE}
legend <- get_legend(
  TCOxAnnualMileage +
    theme(
      legend.position = "bottom",
      legend.justification = "left",   # start from left in its own box
      legend.box.just = "left"
    )
)

# 2. Remove legends from the plots
TCOxAnnualMileagePlot_noleg <- TCOxAnnualMileage + theme(legend.position = "none")
metaPlot_noleg <- MetaTCOxAnnualMileage + theme(legend.position = "none")

# 3. Combine the plots side by side
combined <- plot_grid(
  TCOxAnnualMileagePlot_noleg,
  metaPlot_noleg,
  ncol = 2,
  rel_widths = c(1.2, 0.8),
  align = "v",
  labels = c("a", "b"),
  label_size = baseTextSize,
  label_fontface = "bold",
  label_x = 0.02,
  label_y = 1.02,
  hjust = 0, vjust = 1
) +
  theme(plot.margin = margin(t = 8, r = 3, b = 3, l = 10))

# 4. Shift legend slightly to the right using a spacer
legend_shifted <- plot_grid(
  NULL,      # empty spacer
  legend,
  ncol = 2,
  rel_widths = c(0.05, 0.3)  # First number: empty space on the left.Second number:space the legend occupies.
)

# 5. Combine plots and shifted legend vertically
finalPlot <- plot_grid(
  combined,
  legend_shifted,
  ncol = 1,
  rel_heights = c(1, 0.05)  
)
finalPlot_with_labels <- ggdraw(finalPlot) +
  draw_label(
    "Optimistic", x = 0.02, y = 0.76, angle = 90,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1.2,
    hjust = 0
  ) +
  draw_label(
    "Medium", x = 0.02, y = 0.5, angle = 90,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1.2,
    hjust = 0
  ) +
  draw_label(
    "Pessimistic", x = 0.02, y = 0.185, angle = 90,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1.2,
    hjust = 0
  )


# 6. Display final plot
plot(finalPlot_with_labels)

ggsave(
  filename = file.path(plotFolder, paste0("EconomicallyViableActivity.pdf")),
  plot     = finalPlot_with_labels,
  device   = cairo_pdf,
  width    = 4.5,          # in inches ≈ 180 mm / 25.4
  height   = 5,          # in inches (adjust aspect ratio as appropriate)
  units    = "in",
  dpi      = 300           # ensures minimum resolution for any raster elements
)
```

## Fig 3
## Max daily milage x share of road km  
```{r, fig.width=4.5, fig.height=1.8, fig.fullwidth=FALSE}
vehType <- "Tractor-trailer"

weightedMileage <- prepareMileageData(dataFolder, bin = TRUE, reduce = FALSE)
infrastructure <- loadInfrastructureBuildUp(dataFolder)
rangeAnalysis <- getRangeAnalysis(weightedMileage, infrastructure)
ranges <- loadRanges(dataFolder)

rangePlot <- plotRangeAnalysis(ranges, infrastructure)
dMaxDensityPlot <- plotMileageDensity(weightedMileage)

combined <- plot_grid(
    dMaxDensityPlot,
    rangePlot,
    ncol = 2,
    rel_widths = c(2.3, 8),
    labels = c("a", "b"),
    label_size = baseTextSize,
    label_fontface = "bold",
    label_x = 0.02,
    label_y = 1.02,
    hjust = 0, vjust = 1
  ) +
  theme(plot.margin = margin(t = 15, r = 5, b = 5, l = 12))

plot(combined)


ggsave(
  filename = file.path(plotFolder, paste0("rangeAnalysis.pdf")),
  plot     = combined,
  device   = cairo_pdf,
  width    = 4.5,          # in inches ≈ 180 mm / 25.4
  height   = 1.8,          # in inches (adjust aspect ratio as appropriate)
  units    = "in",
  dpi      = 300           # ensures minimum resolution for any raster elements
)

```

## TCO x Annual mileage distribution bar plot 
```{r, fig.width= 5, fig.height= 8.5, fig.fullwidth=FALSE}
TCOdata <- loadTCO(dataFolder)
binnedWeightedMileage <- prepareMileageData(dataFolder, bin = TRUE, reduce = FALSE)
reducedBinnedWeightedMileage <- prepareMileageData(dataFolder, bin = TRUE, reduce = TRUE)
ranges <- loadRanges(dataFolder)
infrastructure <- loadInfrastructureBuildUp(dataFolder)
dco <- getDCO(DCOscenarios, TCOdata)
setnames(reducedBinnedWeightedMileage, "binMean", "annualM")
DCOmilageDistribution <- applyMileage(reducedBinnedWeightedMileage, dco)
DCOmilageDistributionShares <- calculateFreightActivityShares(DCOmilageDistribution, focus = "EUR")
feasDCO <- checkFeasMileageDistribution(DCOmilageDistribution, binnedWeightedMileage, reducedBinnedWeightedMileage, ranges, infrastructure, focus = "EUR")
setnames(feasDCO, "cumFeasWeightedShareEUR", "cumShare")
#[DCOscenario == "Medium"]


```
# version 1
```{r, fig.width=4.5, fig.height=6.2, fig.fullwidth=FALSE}
paperScenario <- "Current policies"

TCOxAnnualMileage <- amDistributionBarPlot(feasDCO[period < 2041], yr, paperScenario, feas = TRUE)
MetaTCOxAnnualMileage <- metaPlot(feasDCO[period < 2041], paperScenario)

legend <- get_legend(
  TCOxAnnualMileage +
    theme(
      legend.position = "bottom",
      legend.justification = "left",   # start from left in its own box
      legend.box.just = "left"
    )
)

# 2. Remove legends from the plots
TCOxAnnualMileagePlot_noleg <- TCOxAnnualMileage + theme(legend.position = "none")
metaPlot_noleg <- MetaTCOxAnnualMileage + theme(legend.position = "none")

# 3. Combine the plots side by side
combined <- plot_grid(
  TCOxAnnualMileagePlot_noleg,
  metaPlot_noleg,
  ncol = 2,
  rel_widths = c(1.2, 0.8),
  align = "v",
  labels = c("a", "b"),
  label_size = baseTextSize,
  label_fontface = "bold",
  label_x = 0.02,
  label_y = 1.02,
  hjust = 0, vjust = 1
) +
  theme(plot.margin = margin(t = 12, r = 5, b = 5, l = 12))

# 4. Shift legend slightly to the right using a spacer
legend_shifted <- plot_grid(
  NULL,      # empty spacer
  legend,
  ncol = 2,
  rel_widths = c(0.05, 0.3)  # First number: empty space on the left.Second number:space the legend occupies.
)

# 5. Combine plots and shifted legend vertically
finalPlot <- plot_grid(
  combined,
  legend_shifted,
  ncol = 1,
  rel_heights = c(1, 0.05)  
)
finalPlot_with_labels <- ggdraw(finalPlot) +
  draw_label(
    "Optimistic", x = 0.02, y = 0.775, angle = 90,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1.2,
    hjust = 0
  ) +
  draw_label(
    "Medium", x = 0.02, y = 0.525, angle = 90,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1.2,
    hjust = 0
  ) +
  draw_label(
    "Pessimistic", x = 0.02, y = 0.235, angle = 90,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1.2,
    hjust = 0
  )


# 6. Display final plot
plot(finalPlot_with_labels)

ggsave(
  filename = file.path(plotFolder, paste0("FeasibleEconomicallyViableActivityV1.pdf")),
  plot     = finalPlot_with_labels,
  device   = cairo_pdf,
  width    = 4.5,          # in inches ≈ 180 mm / 25.4
  height   = 6.2,          # in inches (adjust aspect ratio as appropriate)
  units    = "in",
  dpi      = 300           # ensures minimum resolution for any raster elements
)

```

# V2
```{r, fig.width=4.5, fig.height=6.2/3, fig.fullwidth=FALSE}
paperScenario <- "Current policies"
DCOscen <- "Medium"
FeasTCOxAnnualMileage2030 <- amDistributionBarPlot(feasDCO[DCOscenario == DCOscen], yr = 2030, paperScenario, feas = TRUE)
FeasTCOxAnnualMileage2040 <- amDistributionBarPlot(feasDCO[DCOscenario == DCOscen], yr = 2040, paperScenario, feas = TRUE)

legend <- get_legend(
  FeasTCOxAnnualMileage2030 +
    theme(
      legend.position = "bottom",
      legend.justification = "left",   # start from left in its own box
      legend.box.just = "left"
    )
)

# 2. Remove legends from the plots
FeasTCOxAnnualMileage2030_noleg <- FeasTCOxAnnualMileage2030 + theme(legend.position = "none")
FeasTCOxAnnualMileage2040_noleg <- FeasTCOxAnnualMileage2040 + theme(legend.position = "none")

# 3. Combine the plots side by side
combined <- plot_grid(
  FeasTCOxAnnualMileage2030_noleg,
  FeasTCOxAnnualMileage2040_noleg,
  ncol = 2,
  rel_widths = c(1, 1),
  align = "h",
  labels = c("a", "b"),
  label_size = baseTextSize,
  label_fontface = "bold",
  label_x = 0.02,
  label_y = 1.02,
  hjust = 0, vjust = 1
) +
  theme(plot.margin = margin(t = 12, r = 5, b = 5, l = 12))

# 4. Shift legend slightly to the right using a spacer
legend_shifted <- plot_grid(
  NULL,      # empty spacer
  legend,
  ncol = 2,
  rel_widths = c(0.05, 0.3)  # First number: empty space on the left.Second number:space the legend occupies.
)

# 5. Combine plots and shifted legend vertically
finalPlot <- plot_grid(
  combined,
  legend_shifted,
  ncol = 1,
  rel_heights = c(1, 0.08)  
)
finalPlot_with_labels <- ggdraw(finalPlot) +
  draw_label(
    DCOscen, x = 0.02, y = 0.45, angle = 90,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1.2,
    hjust = 0
  ) 


# 6. Display final plot
plot(finalPlot_with_labels)

ggsave(
  filename = file.path(plotFolder, paste0("FeasibleEconomicallyViableActivityV2.pdf")),
  plot     = finalPlot_with_labels,
  device   = cairo_pdf,
  width    = 4.5,          # in inches ≈ 180 mm / 25.4
  height   = 6.2/3,          # in inches (adjust aspect ratio as appropriate)
  units    = "in",
  dpi      = 300           # ensures minimum resolution for any raster elements
)




```


# CAPEX to OPEX and shares
```{r, fig.width=7.09, fig.height=3.5, fig.fullwidth=FALSE}

scenario <- "Current policies"
vehType <- "Tractor-trailer"
TCOdata <- loadTCO(dataFolder)
region <- "EUR"
DCO <- getDCO(DCOscenarios, TCOdata, keep = TRUE)
breakeven <- caluclateAnnualMileageBreakeven(DCO)
syntheticalBreakeven <- caluclateSyntheticalBreakeven()
capexVsOpex <- capexVsOpexOverviewPlot(DCO, breakeven, syntheticalBreakeven, scenario, vehType, region)

plot(capexVsOpex)

ggsave(
  filename = file.path(plotFolder, paste0("CAPEvsOPEX.pdf")),
  plot     = capexVsOpex,
  device   = cairo_pdf,
  width    = 7.09,          # in inches ≈ 180 mm / 25.4
  height   = 3.5,          # in inches (adjust aspect ratio as appropriate)
  units    = "in",
  dpi      = 300           # ensures minimum resolution for any raster elements
)

```

# CO₂ Price Required to Bridge the Differential Cost of Ownership
```{r, fig.width=15.5, fig.height=14, fig.fullwidth=FALSE}
# REWORK
#Interesting Sensitivity Scenarios: "Current Policies without CO2 Price", "Sensitivity | Removed Policies except for bio/syn fuel mandates", "Removed Policies" 

paperScen <- "Removed policies"
yr <- c(2030, 2040, 2050)
trucktechs <- c("BET small battery", "BET large battery")
dieselFuel <- "Diesel Mix"

TCOdata <- loadTCO(dataFolder)
mileageDistribution <- prepareMileageData(dataFolder)
DCOdata <- getDCO(DCOscenarios, TCOdata)
setnames(mileageDistribution, "binMean", "annualM")
DCOmilageDistribution <- applyMileage(mileageDistribution, DCOdata)
DCOmilageDistributionShares <- calculateFreightActivityShares(DCOmilageDistribution, focus = "EUR")
gapCo2price <- calculateSwitchCO2price(DCOmilageDistributionShares, dataFolder)


data <- copy(gapCO2Price)[period %in% yr & `truckTechnology` %in% trucktechs & paperScen == sensitivityScen & Fuel == dieselFuel]
data[, DCOscenario := factor(DCOscenario, 
                               levels = c("Optimistic", "Medium", "Pessimistic"))]

data[, cum_width := 0.999* (cumBinWeightedShareEUR * 100 - shift(cumBinWeightedShareEUR * 100, type = "lag")), by = c("DCOscenario", "truckTechnology", "period")]
data[is.na(cum_width), cum_width := (cumBinWeightedShareEUR * 100), by = c("DCOscenario", "truckTechnology", "period")]
co2PriceCurrentPol <- co2PriceCurrentPol[period %in% yr]

findZeroPoints <-  data[ , .SD[which.min(abs(Co2PriceToCloseGap))], by = .(period, `truckTechnology`, DCOscenario)]
setorder(findZeroPoints, DCOscenario, cumBinWeightedShareEUR)
findZeroPoints[, arrow_y := seq(-0.6, -0.9, length.out = .N), by = "DCOscenario"]

setorder(findZeroPoints, - cumBinWeightedShareEUR)
data[, `truckTechnology` := factor(`truckTechnology`, levels = c("BET large battery", "BET small battery"))]
findZeroPoints[, `truckTechnology` := factor(`truckTechnology`, levels = c("BET large battery", "BET small battery"))]  
middle_y <- findZeroPoints[round(nrow(findZeroPoints)/6), arrow_y]

# Create one plot per facet, then stitch them back together
facet_levels <- unique(data$period)
plot_list <- lapply(seq_along(facet_levels), function(i) {
  facet_level <- facet_levels[i]
  sub_data <- subset(data, period == facet_level)
  sub_CO2 <- subset(co2PriceCurrentPol, period == facet_level)
  if (i == 3) {
    extraLabel <- annotate("label", x = 5, y = as.numeric(sub_CO2$value) + 15, label = "CO2 price\nCurrent Policies scenario", 
                           color = "black", fill = "white", fontface = "bold", size = 4.2, hjust = 0, vjust = 0, 
                           label.padding = unit(0.3, "cm"), label.size = 0)} else {
                             extraLabel <- NULL
                           }
  
  test <- ggplot(sub_data) +
    geom_segment(aes(
      x = abs(cumBinWeightedShareEUR * 100 - cum_width),
      xend = cumBinWeightedShareEUR * 100,
      y = Co2PriceToCloseGap,
      yend = Co2PriceToCloseGap,
      color = `truckTechnology`
    ), linewidth = 0.8) +
    geom_rect(aes(
      xmin = cumBinWeightedShareEUR * 100 - cum_width,
      xmax = cumBinWeightedShareEUR * 100,
      ymin = 0,
      ymax = Co2PriceToCloseGap,
      fill = `truckTechnology`,
      color = `truckTechnology`
    ), linewidth = 0.02, alpha = 0.25) +
    geom_hline(yintercept = 0, color = "black", size = 1) +
     geom_hline(yintercept = as.numeric(sub_CO2$value), color = "lightgreen", size = 1) +
    extraLabel +

    scale_x_continuous(expand = c(0, 0), limits = c(0, 1.05 * max(data$cumBinWeightedShareEUR * 100, na.rm = TRUE))) +
    coord_cartesian(ylim = c(-600, 1050)) +
    scale_color_manual(values = paperColors) +
    scale_fill_manual(values = paperColors) +
    labs(
      x = if (i == 2) "Share of road km in considered truck markets [%]" else NULL,
      y = if (i == 1) "CO2 price to bridge DCO [EUR/tCO2]" else NULL,
      title = paste0(unique(sub_data$paperScen), "\n", facet_level)
    ) +
    facet_wrap(~DCOscenario, ncol = 1) +
    themePanel +
    theme(
      strip.text = element_text(face = "bold")
    )
})
library(patchwork)

combined <- wrap_plots(plot_list, ncol = 3, guides = "collect") &
  theme(legend.position = "bottom")
combined <- combined & theme(
  legend.margin = margin(t = 20),
  legend.text = element_text(size = rel(1)),
  legend.title = element_text(size = rel(1))
)

dir <- dirname(getwd())
ggsave(
  file.path(plotFolder, paste0("CO2price.pdf")),
  plot = combined,
  width = 15.5, height = 14, units = "in", device = cairo_pdf
)
plot(combined)
```





