---
title: "Annual mileage distribution plots EUR"
author: "Johanna Hoppe"
date: "2025-02-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)#
library(ggplot2)
library(data.table)
library(RColorBrewer)
library(ggtext)
library(ggh4x)
library(ggforce)
library(patchwork)
#Insert pth to mileage data
AMdataPath <- "C:/Users/johannah/Documents/Paper/TCO/ISI driving profiles/export_veh_km.csv"
# Get the directory of the currently running script or Rmd
folder_path <- dirname(this.path::this.dir())
```

```{r}

# Apply mileage data on TCO (using bins to split mileage data)
# Calculate TCOgap compared to Diesel-mix for each bin
# Prepare data for plotting
#Variablen:
#“vehicleid" = FahrzeugNr. Beginnt mit Jahr der Erhebung
#"GKtype" = Größenklasse
#"country" = Land (nur unsere sieben behnalten hierfür)
#"weekkm" = Summe der Wege-km in einer Woche (bei DE nur halb woche aufgezeichenet, daher für vergleichbarkeit schon mal zwei genommen)
#"N" = Anzahl Wege des Fahrzeuges in der Woche
#"avkt" = Jahresfahrleistung = Wochen-km*52

# Sort AM data
AMdata <- fread(file = AMdataPath, header = TRUE, sep = ",", dec=".")
AMdata[, V1 := NULL]
AMdata[, period := substr(vehicleid, 1, 4)]
AMdata[, avkt := as.numeric(avkt)]
setnames(AMdata, "GKtype", "Vehicle Size")
AMdata[`Vehicle Size` == "tractor-trailer", `Vehicle Size` := "Tractor-Trailer"]
AMdata[`Vehicle Size` == "rigid", `Vehicle Size` := "Rigid"]
setnames(AMdata, "country", "Country")

AMdata <- AMdata[!(`Vehicle Size` == "other" | Country == "SE")]

# Split AM data into equally sized bins
# Define global bin breaks based on the entire dataset
global_breaks <- seq(min(AMdata$avkt, na.rm = TRUE), max(AMdata$avkt, na.rm = TRUE), length.out = 201)

# Apply the same breaks to all groups
AMdata[, avkt_binned := cut(avkt, breaks = global_breaks, include.lowest = TRUE)]
# Calculate mean annual mileage for each bin
AMdata[, binMean := mean(avkt), by = c("avkt_binned", "Vehicle Size", "Country")]
# Calculate total yearly road km for each bin 
AMdata <- AMdata[, .(totRoadkm = sum(avkt)), by = c("Country", "Vehicle Size", "avkt_binned", "binMean")]
# Calculate total road km for EUR
AMdata[, totRoadkmEUR := sum(totRoadkm)]
# Calculate share of each bin in the total yearly road km in EUR 
AMdata[, shareKmEUR := totRoadkm/totRoadkmEUR]
```

```{r}
plotData <- fread(file.path(folder_path, "calcTCOData", "3_ScenarioSpecificTCOdataFlexAM", "TCO_ACEAscen.csv"))
co2PriceCurrentPol <- fread(file.path(folder_path, "calcTCOData", "2_TCOdataFlexAM", "CO2Price_currentPol.csv"))
co2PriceCurrentPol <- co2PriceCurrentPol[paperScen == "Current Policies"]
co2PriceCurrentPol <- unique(co2PriceCurrentPol[, c("period", "value")])
plotData <- plotData[paperScen %in% c("Current Policies", "Removed Policies")]

groupParameters <- FALSE
source(file.path(folder_path, "Plotting scripts", "PrepareTCOdataForPlotting.R"))
TCO_plotting <- plotData[, .(value = sum(value)), by = c("Country", "Vehicle Size", "Fuel Type", "ACEAscen", "paperScen", "Unit", "period")]

#OPEX and CAPEX still separated
#Harmonize the assumption for 2025 (starting point)

TCOdrivingProfiles <- merge(TCO_plotting, AMdata, by = c("Country", "Vehicle Size"), allow.cartesian = TRUE)
TCOdrivingProfiles[Unit == "EUR/veh yr", value := value/binMean]
TCOdrivingProfiles[Unit == "EUR/veh yr", Unit := "EUR/km"]
#Sum up after unifying the unit
TCOdrivingProfiles <- TCOdrivingProfiles[, .(value = sum(value)), by = c("Country", "Vehicle Size", "Fuel Type", "ACEAscen", "paperScen", "Unit", "period", "avkt_binned", "shareKmEUR", "binMean")]

# Calculate TCO gap compared to Diesel Mix
FCET <- TCOdrivingProfiles[`Fuel Type` == "CH2 FCET"]
setnames(FCET, "value", "totFCET")
FCET <- unique(FCET[, c("Country", "Vehicle Size", "ACEAscen", "paperScen", "period", "totFCET", "avkt_binned")])

TCOdrivingProfiles <- TCOdrivingProfiles[!`Fuel Type` %in% c("Gas ICE", "Diesel Fossil", 
                                                             "Diesel Syn", "Diesel Bio", "Diesel Mix", "CH2 FCET", "LH2 FCET")]
TCOdrivingProfiles <- merge(TCOdrivingProfiles, FCET, by = c("Country", "Vehicle Size", "ACEAscen", "paperScen", "avkt_binned", "period"))
TCOdrivingProfiles[, TCOgap := value - totFCET][, totFCET := NULL]

#Selecting the edge Scenarios
#Selecting the edge Scenarios
TCOdrivingProfiles <- TCOdrivingProfiles[`Fuel Type` == "BET Mid" & ACEAscen %in% c("TechnologyAdvancesXELEa",
                                                                                      "TechnologyAdvancesXH2a",
                                                                                      "MediumAll") |
                                         `Fuel Type` == "BET Long" & ACEAscen %in% c("TechnologyAdvancesXELEa",
                                                                                       "TechnologyAdvancesXH2a",
                                                                                       "MediumAll")]

#Renaming scenarios
TCOdrivingProfiles[`Fuel Type` %in%  c("BET Mid", "BET Long") & ACEAscen == "TechnologyAdvancesXELEa", ACEAscen := "a:   Optimistic"]
TCOdrivingProfiles[`Fuel Type` %in%  c("BET Mid", "BET Long") & ACEAscen =="TechnologyAdvancesXH2a", ACEAscen := "c:   Pessimistic"]
TCOdrivingProfiles[ACEAscen =="MediumAll", ACEAscen := "b:   Medium"]

TCOdrivingProfiles[`Fuel Type` == "BET Long", `Fuel Type` := "BET-LB"]
TCOdrivingProfiles[`Fuel Type` == "BET Mid", `Fuel Type` := "BET-SB"]
TCOdrivingProfiles[`Fuel Type` == "CH2 FCET", `Fuel Type` := "FCET"]

setorder(TCOdrivingProfiles, "Fuel Type",  "period", "paperScen","ACEAscen", "TCOgap")

TCOdrivingProfiles[, share := cumsum(shareKmEUR)*100, by = c("Fuel Type", "ACEAscen", "paperScen", "period")]

```



```{r, fig.width=30, fig.height=10, fig.fullwidth=FALSE}

yr <- c(2030)
trucktechs <- c("BET-LB", "BET-SB")
data <- copy(TCOdrivingProfiles)[period %in% yr & `Fuel Type` %in% trucktechs & paperScen == "Current Policies"]
data[, cum_width := 0.999* (share - shift(share, type = "lag")), by = c("paperScen", "ACEAscen", "Fuel Type")]
data[is.na(cum_width), cum_width := (share), by = c("paperScen", "ACEAscen", "Fuel Type")]

data[, paperScen := factor(paperScen, 
                               levels = c("Current Policies"))]
data[, ACEAscen := factor(ACEAscen, 
                               levels = c("a:   Optimistic", "b:   Medium", "c:   Pessimistic"))]

findZeroPoints <-  data[ , .SD[which.min(abs(TCOgap))], by = .(period, `Fuel Type`, paperScen, ACEAscen)]
setorder(findZeroPoints, paperScen, ACEAscen, share)
findZeroPoints[, arrow_y := seq(-0.4, -0.6, length.out = .N), by = c("paperScen", "ACEAscen")]

setorder(findZeroPoints, - share)
data[, `Fuel Type` := factor(`Fuel Type`, levels = unique(findZeroPoints$`Fuel Type`))]
findZeroPoints[, `Fuel Type` := factor(`Fuel Type`, levels = unique(findZeroPoints$`Fuel Type`))]  
middle_y <- findZeroPoints[round(nrow(findZeroPoints)/6), arrow_y]



data$facet_order <- as.numeric(factor(data$ACEAscen))
findZeroPoints$facet_order <- as.numeric(factor(findZeroPoints$ACEAscen))

# Create one plot per facet, then stitch them back together
facet_levels <- unique(data$ACEAscen)
plot_list <- lapply(seq_along(facet_levels), function(i) {
  facet_level <- facet_levels[i]
  sub_data <- subset(data, ACEAscen == facet_level)
  sub_zero <- subset(findZeroPoints, ACEAscen == facet_level)
  
  ggplot(sub_data) +
    geom_segment(aes(
      x = abs(share - cum_width),
      xend = share,
      y = TCOgap,
      yend = TCOgap,
      color = `Fuel Type`
    ), linewidth = 0.8) +
    geom_rect(aes(
      xmin = share - cum_width,
      xmax = share,
      ymin = 0,
      ymax = TCOgap,
      fill = `Fuel Type`,
      color = `Fuel Type`
    ), linewidth = 0.02, alpha = 0.25) +
    geom_point(data = sub_zero, aes(x = share, y = 0), 
               shape = 1, size = 7, stroke = 2, fill = NA, color = "black") +
    geom_vline(data = sub_zero, aes(xintercept = share, color = `Fuel Type`), 
               linetype = "dashed", linewidth = 1) +
    geom_segment(data = sub_zero, aes(x = 0, xend = share, y = arrow_y, yend = arrow_y, color = `Fuel Type`), 
                 arrow = arrow(length = unit(0.3, "cm"), type = "open"), 
                 linewidth = 1) +
    geom_label(data = sub_zero, 
               aes(x = 20, y = arrow_y, 
                   label = paste("~", round(share), "%")),
               color = "black", fill = "white",
               size = 10, fontface = "bold",
               label.padding = unit(0.2, "cm"),
               label.size = 0, hjust = 0.5, vjust = 0.5) +
    annotate("label", x = 27, y = middle_y, label = "of road km cost beneficial", 
             color = "black", fill = "white", fontface = "bold", size = 8, hjust = 0, vjust = 0.5,
             label.padding = unit(0.3, "cm"), label.size = 0) +
    geom_hline(yintercept = 0, color = "black", size = 1) +
    scale_x_continuous(expand = c(0, 0), limits = c(0, 1.05 * max(data$share, na.rm = TRUE))) +
    coord_cartesian(ylim = c(-0.7, 0.5)) +
    scale_color_manual(values = c("BET-SB" = "#17BECF", "BET-LB" = "#9467BD")) +
    scale_fill_manual(values = c("BET-SB" = "#17BECF", "BET-LB" = "#9467BD")) +
    labs(
      x = if (i == 2) "Share of road km in considered truck markets [%]" else NULL,
      y = if (i == 1) "TCO gap to FCET [EUR/km]" else NULL,
      title = facet_level
    ) +
    theme_minimal(base_size = 30) +
    theme(
      axis.text.y = if (i == 1) element_text(size = rel(1)) else element_blank(),
      axis.ticks.y = if (i == 1) element_line() else element_blank(),
      axis.line.y = element_line(),
      panel.grid = element_blank(),
      panel.spacing = unit(0.9, "lines"),
      plot.title = element_text(size = rel(1), face = "bold", hjust = 0.5),
      axis.title.y = if (i == 1) element_text(size = rel(1), margin = margin(r = 12)) else element_blank()
    )
})
library(patchwork)

combined <- wrap_plots(plot_list, ncol = 3, guides = "collect") &
  theme(legend.position = "bottom")
combined <- combined & theme(
  legend.margin = margin(t = 20),
  legend.text = element_text(size = rel(1)),
  legend.title = element_text(size = rel(1))
)
ggsave(
  file.path(dir, "plots", "BETvsFCET.pdf"),
  plot = combined,
  width = 30, height = 10, units = "in", device = cairo_pdf
)
plot(combined)

```

```{r, fig.width=27, fig.height=12, fig.fullwidth=FALSE}
#Meta plot 
trucktechs <- c("BET-LB", "BET-SB", "FCET")
data <- copy(TCOdrivingProfiles)[`Fuel Type` %in% trucktechs]
findZeroPoints <- data[ , .SD[which.min(abs(TCOgap))], by = .(period, `Fuel Type`, paperScen, ACEAscen)][
  , .(period, `Fuel Type`, paperScen, ACEAscen, share)
]
setnames(findZeroPoints, c("paperScen", "ACEAscen"), c("Policy scenario", "Sensitivity scenario"))

p <- ggplot(
  findZeroPoints[!`Policy scenario` == "Urban Depot Charging" & period > 2020], 
  aes(color = `Fuel Type`, linetype = `Policy scenario`)
) +
  geom_line(aes(x = period, y = share), linewidth = 1.5) +
  
  scale_color_manual(values = c("BET-SB" = "#17BECF", "BET-LB" = "#9467BD", "FCET" = "#E65C00")) +
  scale_linetype_manual(values = c(
  "Current Policies" = "dashed",
  "Removed Policies" = "solid"
))+
  # Facet settings: No spacing & fixed scales
  facet_grid2(
    #rows = vars(paperScen),
    cols = vars(`Sensitivity scenario`),
    scales = "fixed",
    axes = "all"  # <- this makes all axes (x and y) visible
  ) +
  # Title and labels
  labs(
    x = "Year",
    y = "Share of road km in considered truck markets [%]")+
  coord_cartesian(ylim = c(0, 100))+ 

  # Theme modifications
  theme_minimal(base_size = 30) +
    theme(
      axis.text.y = element_text(size = rel(1)),
      axis.ticks.y = element_line(),
      axis.line.y = element_line(),
      panel.grid = element_blank(),
    panel.spacing = unit(0.9, "lines"),
    strip.text = element_text(size = rel(1.2), face = "bold"),
    legend.key.width = unit(2.5, "cm"),

    # Force x-axis to be drawn in every facet
    axis.line.x = element_line(color = "black", size = 0.8),  # x-axis line
    axis.ticks.x = element_line(color = "black", size = 0.8),  # x-axis ticks
    axis.text.x = element_text(size = rel(1), color = "black")  # x-axis labels
  )
plot(p)

ggsave(file.path(dir, "plots", paste0("AMdistributionMetaPlotEUR.pdf")), plot = p, device = cairo_pdf, width = 27, height = 9, units = "in")

```


```{r, fig.width=30, fig.height=10, fig.fullwidth=FALSE}

library(ggplot2)
library(ggforce)
library(patchwork)
yr <- c(2030, 2040, 2050)
trucktechs <- c("BET-LB", "BET-SB")
data <- copy(gapCO2Price)[period %in% yr & `Fuel Type` %in% trucktechs & paperScen == "Removed Policies" & ACEAscen =="c:   Rather pessimistic"]
data[, cum_width := 0.999* (share - shift(share, type = "lag")), by = c("ACEAscen", "Fuel Type", "period")]
data[is.na(cum_width), cum_width := (share), by = c("ACEAscen", "Fuel Type", "period")]
co2PriceCurrentPol <- co2PriceCurrentPol[period %in% yr]
# Cut highest and lowest data
data[Co2PriceToCloseGap >= 1000, Co2PriceToCloseGap := 1000]

findZeroPoints <-  data[ , .SD[which.min(abs(Co2PriceToCloseGap))], by = .(period, `Fuel Type`, ACEAscen)]
setorder(findZeroPoints, ACEAscen, share)
findZeroPoints[, arrow_y := seq(-0.6, -0.9, length.out = .N), by = "ACEAscen"]

setorder(findZeroPoints, - share)
data[, `Fuel Type` := factor(`Fuel Type`, levels = unique(findZeroPoints$`Fuel Type`))]
findZeroPoints[, `Fuel Type` := factor(`Fuel Type`, levels = unique(findZeroPoints$`Fuel Type`))]  
middle_y <- findZeroPoints[round(nrow(findZeroPoints)/6), arrow_y]





# Create one plot per facet, then stitch them back together
facet_levels <- unique(data$period)
plot_list <- lapply(seq_along(facet_levels), function(i) {
  facet_level <- facet_levels[i]
  sub_data <- subset(data, period == facet_level)
  sub_CO2 <- subset(co2PriceCurrentPol, period == facet_level)
  
  ggplot(sub_data) +
    geom_segment(aes(
      x = abs(share - cum_width),
      xend = share,
      y = Co2PriceToCloseGap,
      yend = Co2PriceToCloseGap,
      color = `Fuel Type`
    ), linewidth = 0.8) +
    geom_rect(aes(
      xmin = share - cum_width,
      xmax = share,
      ymin = 0,
      ymax = Co2PriceToCloseGap,
      fill = `Fuel Type`,
      color = `Fuel Type`
    ), linewidth = 0.02, alpha = 0.25) +
    geom_hline(yintercept = 0, color = "black", size = 1) +
     geom_hline(yintercept = sub_CO2$value, color = "lightgreen", size = 2) +
     annotate("label", x = 27, y = sub_CO2$value, label = "CO2 price in Current Policies scenario", 
           color = "black", fill = "white", fontface = "bold", size = 6, hjust = 0, vjust = 0.5, 
           label.padding = unit(0.3, "cm"), label.size = 0) +

    scale_x_continuous(expand = c(0, 0), limits = c(0, 1.05 * max(data$share, na.rm = TRUE))) +
    coord_cartesian(ylim = c(-600, 1050)) +
    scale_color_manual(values = c("BET-SB" = "#17BECF", "BET-LB" = "#9467BD", "FCET" = "#E65C00")) +
    scale_fill_manual(values = c("BET-SB" = "#17BECF", "BET-LB" = "#9467BD", "FCET" = "#E65C00")) +
    labs(
      x = if (i == 2) "Share of road km in considered truck markets [%]" else NULL,
      y = if (i == 1) "CO2 price to close TCO gap [EUR/tCO2]" else NULL,
      title = facet_level
    ) +
    theme_minimal(base_size = 30) +
    theme(
      axis.text.y = element_text(size = rel(1)),
      axis.ticks.y = element_line(),
      axis.line.y = element_line(),
      panel.grid = element_blank(),
      panel.spacing = unit(0.9, "lines"),
      plot.title = element_text(size = rel(1), face = "bold", hjust = 0.5),
      axis.title.y = element_text(size = rel(1), margin = margin(r = 12)) 
    )
})
library(patchwork)

combined <- wrap_plots(plot_list, ncol = 3, guides = "collect") &
  theme(legend.position = "bottom")
combined <- combined & theme(
  legend.margin = margin(t = 20),
  legend.text = element_text(size = rel(1)),
  legend.title = element_text(size = rel(1))
)
ggsave(
  file.path(dir, "plots", "CO2price.pdf"),
  plot = combined,
  width = 30, height = 10, units = "in", device = cairo_pdf
)
plot(combined)
```

