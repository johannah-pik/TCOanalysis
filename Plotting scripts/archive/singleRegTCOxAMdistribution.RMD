---
title: "Annual mileage distribution plots regional deepdive"
author: "Johanna Hoppe"
date: "2025-02-03"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_document:
    toc: yes
    toc_depth: 2
---

<style type="text/css">

h1.title {
  font-size: 26px;
}
h1 { /* Header 1 */
  font-size: 22px;
}
h2 { /* Header 2 */
    font-size: 20px;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
}

</style>
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)#
library(ggplot2)
library(data.table)
library(RColorBrewer)
#Insert pth to mileage data
AMdataPath <- "C:/Users/johannah/Documents/Paper/TCO/ISI driving profiles/export_veh_km.csv"
# Get the directory of the currently running script or Rmd
folder_path <- dirname(this.path::this.dir())
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

# Apply mileage data on TCO (using bins to split mileage data)
# Calculate TCOgap compared to Diesel-mix for each bin
# Prepare data for plotting

# Sort AM data
AMdata <- fread(file = AMdataPath, header = TRUE, sep = ",", dec=".")
AMdata[, V1 := NULL]
AMdata[, period := substr(vehicleid, 1, 4)]
AMdata[, avkt := as.numeric(avkt)]
setnames(AMdata, "GKtype", "Vehicle Size")
AMdata[`Vehicle Size` == "tractor-trailer", `Vehicle Size` := "Tractor-Trailer"]
AMdata[`Vehicle Size` == "rigid", `Vehicle Size` := "Rigid"]
setnames(AMdata, "country", "Country")

AMdata <- AMdata[!`Vehicle Size` == "other"]
# Split AM data into equally sized bins
# Define global bin breaks based on the entire dataset
global_breaks <- seq(min(AMdata$avkt, na.rm = TRUE), max(AMdata$avkt, na.rm = TRUE), length.out = 201)

# Apply the same breaks to all groups
AMdata[, avkt_binned := cut(avkt, breaks = global_breaks, include.lowest = TRUE)]
# Calculate mean annual mileage for each bin
AMdata[, binMean := mean(avkt), by = c("avkt_binned", "Vehicle Size", "Country")]
# Calculate total yearly road km for each bin 
AMdata <- AMdata[, .(totRoadkm = sum(avkt)), by = c("Country", "Vehicle Size", "avkt_binned", "binMean")]
# Calculate total road km for each country
AMdata[, totRoadkmCountry := sum(totRoadkm), by = c("Country")]
# Calculate share of each bin in the total yearly road km in EUR 
AMdata[, shareKmCountry := totRoadkm/totRoadkmCountry]
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
plotData <- fread(file.path(folder_path, "calcTCOData", "3_ScenarioSpecificTCOdataFlexAM", "TCO_ACEAscen.csv"))
plotData <- plotData[paperScen == "Default"]
groupParameters <- FALSE
source(file.path(folder_path, "Plotting scripts", "PrepareTCOdataForPlotting.R"))
TCO_plotting <- plotData 
TCO_plotting <- TCO_plotting[, .(value = sum(value)), by = c("Country", "Vehicle Size", "Fuel Type", "ACEAscen", "Unit", "period")]

#OPEX and CAPEX still separated
TCOdrivingProfiles <- merge(TCO_plotting, AMdata, by = c("Country", "Vehicle Size"), allow.cartesian = TRUE)
TCOdrivingProfiles[Unit == "EUR/veh yr", value := value/binMean]
TCOdrivingProfiles[Unit == "EUR/veh yr", Unit := "EUR/km"]
#Sum up after unifying the unit
TCOdrivingProfiles <- TCOdrivingProfiles[, .(value = sum(value)), by = c("Country", "Vehicle Size", "Fuel Type", "ACEAscen", "Unit", "period", "avkt_binned", "shareKmCountry", "binMean")]

#Selecting the edge Scenarios
#Selecting the edge Scenarios
TCOdrivingProfiles <- TCOdrivingProfiles[`Fuel Type` %in% c("CH2 FCET", "LH2 FCET") & ACEAscen %in% c("TechnologyAdvancesXH2a",
                                                                                     "TechnologyAdvancesXCNFa",
                                                                                     "TechnologyBottlenecksXH2b",
                                                                                     "TechnologyBottlenecksXELEb",
                                                                                     "MediumAll") |
                                      
                                           `Fuel Type`%in% c("BET Long", "BET Mid") & ACEAscen %in% c("TechnologyAdvancesXELEa",
                                                                                      "TechnologyAdvancesXCNFa",
                                                                                      "TechnologyBottlenecksXELEb",
                                                                                      "TechnologyBottlenecksXH2b",
                                                                                      "MediumAll")]


#Renaming scenarios
TCOdrivingProfiles[`Fuel Type` %in%  c("CH2 FCET", "LH2 FCET") & ACEAscen == "TechnologyAdvancesXH2a", ACEAscen := "Fully optimisitc"]
TCOdrivingProfiles[`Fuel Type` %in%  c("CH2 FCET", "LH2 FCET") & ACEAscen == "TechnologyAdvancesXCNFa", ACEAscen := "Fully pessimistic"]
TCOdrivingProfiles[`Fuel Type` %in%  c("CH2 FCET", "LH2 FCET") & ACEAscen == "TechnologyBottlenecksXH2b", ACEAscen := "Mixed A"]
TCOdrivingProfiles[`Fuel Type` %in%  c("CH2 FCET", "LH2 FCET") & ACEAscen == "TechnologyBottlenecksXELEb", ACEAscen := "Mixed B"]

TCOdrivingProfiles[`Fuel Type` %in%  c("BET Mid", "BET Long") & ACEAscen == "TechnologyAdvancesXELEa", ACEAscen := "Fully optimisitc"]
TCOdrivingProfiles[`Fuel Type` %in%  c("BET Mid", "BET Long") & ACEAscen =="TechnologyAdvancesXCNFa", ACEAscen := "Fully pessimistic"]
TCOdrivingProfiles[`Fuel Type` %in%  c("CH2 FCET", "LH2 FCET") & ACEAscen ==  "TechnologyBottlenecksXELEb", ACEAscen := "Mixed A"]
TCOdrivingProfiles[`Fuel Type` %in%  c("CH2 FCET", "LH2 FCET") & ACEAscen == "TechnologyBottlenecksXH2b", ACEAscen := "Mixed B"]
TCOdrivingProfiles[ACEAscen =="MediumAll", ACEAscen := "Medium"]




TCOdrivingProfiles <- setorder(TCOdrivingProfiles, "period", "Fuel Type", "Country", "Vehicle Size", "ACEAscen", "binMean")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

ACEAscenLineTypes <- c(
  "MediumAll" = "solid",      
  "BalancedTechnologyXELE" = "solid",
  "BalancedTechnologyXH2" = "solid",
  "BalancedTechnologyXCNF" = "solid",
  "TechnologyAdvancesXELEa" = "solid",
  "TechnologyAdvancesXELEb" = "solid",
  "TechnologyAdvancesXH2a" = "solid",
  "TechnologyAdvancesXH2b" = "solid",
  "TechnologyAdvancesXCNFa" = "solid",
  "TechnologyAdvancesXCNFb" = "solid",
  "TechnologyBottlenecksXELEa" = "dotted",
  "TechnologyBottlenecksXELEb" = "dashed",
  "TechnologyBottlenecksXH2a" = "solid",
  "TechnologyBottlenecksXH2b" = "dashed",
  "TechnologyBottlenecksXCNFa" = "dashed",
  "TechnologyBottlenecksXCNFb" = "dashed"
)

ACEAscenColors <- c(
  "MediumAll" = "#1F78B4",      # Strong Blue
  "BalancedTechnologyXELE" = "#E31A1C",  # Bright Red
  "BalancedTechnologyXH2" = "#33A02C",   # Deep Green
  "BalancedTechnologyXCNF" = "#FF7F00",  # Bright Orange
  "TechnologyAdvancesXELEa" = "#6A3D9A", # Dark Purple
  "TechnologyAdvancesXELEb" = "#B15928", # Brown
  "TechnologyAdvancesXH2a" = "#A6CEE3",  # Light Blue
  "TechnologyAdvancesXH2b" = "#FB9A99",  # Soft Red
  "TechnologyAdvancesXCNFa" = "#B2DF8A", # Light Green
  "TechnologyAdvancesXCNFb" = "#FDBF6F", # Light Orange
  "TechnologyBottlenecksXELEa" = "#CAB2D6", # Soft Purple
  "TechnologyBottlenecksXELEb" = "#8C564B", # Dark Brown
  "TechnologyBottlenecksXH2a" = "#F0027F",  # Magenta
  "TechnologyBottlenecksXH2b" = "#117733",  # Forest Green
  "TechnologyBottlenecksXCNFa" = "#CC79A7", # Pink
  "TechnologyBottlenecksXCNFb" = "#D55E00"  # Burnt Orange
)

newACEAscenColors <- c(
  "Medium" = "#2F5597",
  "Fully optimisitc" = "#8FAADC",
  "Fully pessimistic" = "#203864",
  "Mixed A" = "#F0027F",
  "Mixed B" = "#FDBF6F"
  
)


TCOdrivingProfiles <- TCOdrivingProfiles[period == 2030 & Country == "DE"]

# Define unique values for looping
periods <- unique(TCOdrivingProfiles$period)
fuel_types <- unique(TCOdrivingProfiles$`Fuel Type`)
vehicle_sizes <- unique(TCOdrivingProfiles$`Vehicle Size`)
countries <- unique(TCOdrivingProfiles$Country)

```


```{r echo=FALSE, fig.fullwidth=FALSE, fig.height=10, fig.width=14, message=FALSE, warning=TRUE, include= T, results="asis"}



# Loop through all combinations
for (focusCountry in countries) {
  if (focusCountry == countries[1]) cat(paste("# Country: " , focusCountry,"\n"))
  for (yr in periods) {
    if (yr == periods[1]) cat(paste("## Year: ", yr,"\n"))
    for (trucktechs in fuel_types) {
      if (trucktechs == fuel_types[1]) cat(paste("## Technology: ", trucktechs,"\n"))
      for (vehicleSize in vehicle_sizes) {
        if (vehicleSize == vehicle_sizes[1]) cat(paste("#### Truck size: ", vehicleSize,"\n"))
        
        # Filter data for current combination
        data <- copy(TCOdrivingProfiles)[
          period == yr & `Fuel Type` == trucktechs & 
            Country == focusCountry & `Vehicle Size` == vehicleSize
        ]
        
        # Exclude extreme values
        data <- data[!binMean > 100000]
        
        # Ensure factor levels are preserved
        data <- data[, ACEAscen := factor(ACEAscen, levels = unique(data$ACEAscen))]
        
        # Only plot if there's data
        if (nrow(data) > 0) {
          
          # Generate the plot
          p <- ggplot(data, aes(x = binMean, y = value, color = ACEAscen, linetype = ACEAscen)) +
            geom_line(linewidth = 1) +
            theme_minimal() +
            scale_color_manual(values =newACEAscenColors) +
            labs(
              x = "Annual mileage",
              y = "TCO",
              title = paste("TCO over Annual Mileage (", yr, ")", 
                            "\nFuel Type:", trucktechs, 
                            "| Vehicle Size:", vehicleSize, 
                            "| Country:", focusCountry)
            ) +
            scale_y_continuous(limits = c(0.3, 6.7)) +
            scale_x_continuous(limits = c(11000, 100000)) +
            theme(
              text = element_text(size = 14),
              axis.title = element_text(size = 14),
              axis.text = element_text(size = 14, color = "black"),
              strip.text = element_text(size = 14),
              legend.key.size = unit(0.7, "cm"),
              legend.text = element_text(size = 10),
              legend.title = element_blank()
            )
          
          # Print plot so it renders in R Markdown
          print(p)
          
        } # End if data check
        
      } # End country loop
    } # End vehicle size loop
  } # End fuel type loop
} # End period loop

```



