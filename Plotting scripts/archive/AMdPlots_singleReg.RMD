---
title: "Annual mileage distribution plots regional deepdive"
author: "Johanna Hoppe"
date: "2025-02-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)#
library(ggplot2)
library(data.table)
library(RColorBrewer)
library(ggh4x)
#Insert pth to mileage data
AMdataPath <- "C:/Users/johannah/Documents/Paper/TCO/ISI driving profiles/export_veh_km.csv"
# Get the directory of the currently running script or Rmd
folder_path <- dirname(this.path::this.dir())
```

```{r}

# Apply mileage data on TCO (using bins to split mileage data)
# Calculate TCOgap compared to Diesel-mix for each bin
# Prepare data for plotting

# Sort AM data
AMdata <- fread(file = AMdataPath, header = TRUE, sep = ",", dec=".")
AMdata[, V1 := NULL]
AMdata[, period := substr(vehicleid, 1, 4)]
AMdata[, avkt := as.numeric(avkt)]
setnames(AMdata, "GKtype", "Vehicle Size")
AMdata[`Vehicle Size` == "tractor-trailer", `Vehicle Size` := "Tractor-Trailer"]
AMdata[`Vehicle Size` == "rigid", `Vehicle Size` := "Rigid"]
setnames(AMdata, "country", "Country")

AMdata <- AMdata[!`Vehicle Size` == "other"]
# Split AM data into equally sized bins
# Define global bin breaks based on the entire dataset
global_breaks <- seq(min(AMdata$avkt, na.rm = TRUE), max(AMdata$avkt, na.rm = TRUE), length.out = 201)

# Apply the same breaks to all groups
AMdata[, avkt_binned := cut(avkt, breaks = global_breaks, include.lowest = TRUE)]
# Calculate mean annual mileage for each bin
AMdata[, binMean := mean(avkt), by = c("avkt_binned", "Vehicle Size", "Country")]
# Calculate total yearly road km for each bin 
AMdata <- AMdata[, .(totRoadkm = sum(avkt)), by = c("Country", "Vehicle Size", "avkt_binned", "binMean")]
# Calculate total road km for each country
AMdata[, totRoadkmCountry := sum(totRoadkm), by = c("Country")]
# Calculate share of each bin in the total yearly road km in EUR 
AMdata[, shareKmCountry := totRoadkm/totRoadkmCountry]


dummyAMdata <- data.table(AM = c(seq(0, 100000, length.out = 201)))
dummyAMdata[, test := "All"]
```

```{r}
plotData <- fread(file.path(folder_path, "calcTCOData", "3_ScenarioSpecificTCOdataFlexAM", "TCO_ACEAscen.csv"))

plotData <- plotData[paperScen %in% c("Removed Policies", "Current Policies")]
groupParameters <- FALSE
source(file.path(folder_path, "Plotting scripts", "PrepareTCOdataForPlotting.R"))
TCO_plotting <- plotData 
TCO_plotting <- TCO_plotting[, .(value = sum(value)), by = c("Country", "Vehicle Size", "Fuel Type", "ACEAscen", "paperScen", "Unit", "period")]

#OPEX and CAPEX still separated
#TCOdrivingProfiles <- merge(TCO_plotting, AMdata, by = c("Country", "Vehicle Size"), allow.cartesian = TRUE)
#TCOdrivingProfiles[Unit == "EUR/veh yr", value := value/binMean]
TCO_plotting[, test := "All"]
TCOdrivingProfiles <- merge(TCO_plotting, dummyAMdata, by = c("test"), allow.cartesian = TRUE)
TCOdrivingProfiles[Unit == "EUR/veh yr", value := value/AM]

TCOdrivingProfiles[Unit == "EUR/veh yr", Unit := "EUR/km"]
#Sum up after unifying the unit
TCOdrivingProfiles <- TCOdrivingProfiles[, .(value = sum(value)), by = c("Country", "Vehicle Size", "Fuel Type", "ACEAscen", "paperScen", "Unit", "period", "AM")]
#TCOdrivingProfiles <- setorder(TCOdrivingProfiles, "period", "Fuel Type", "Country", "Vehicle Size", "paperScen", "ACEAscen",  "AM")

# Calculate TCO gap compared to Diesel Mix
DieselMix <- TCOdrivingProfiles[`Fuel Type` == "Diesel Mix"]
setnames(DieselMix, "value", "totDieselMix")
DieselMix <- unique(DieselMix[, c("Country", "Vehicle Size", "ACEAscen", "period", "totDieselMix", "AM")])

#TCOgapProfiles <- TCOdrivingProfiles[!`Fuel Type` %in% c("Diesel Fossil", "Diesel Bio", "Diesel Syn", "Diesel Mix")]
#TCOgapProfiles <- merge(TCOgapProfiles, DieselMix, by = c("Country", "Vehicle Size", "ACEAscen", "AM", "period"))
#TCOgapProfiles[, TCOgap := value - totDieselMix][, totDieselMix := NULL]
#TCOgapProfiles <- setorder(TCOgapProfiles, "Country","period", "Fuel Type", "ACEAscen", "TCOgap")
#TCOgapProfiles[, share := cumsum(shareKmCountry) * 100, by = c("Country", "period", "Fuel Type", "ACEAscen")]

TCOdrivingProfiles <- TCOdrivingProfiles[`Fuel Type` == "CH2 FCET" & ACEAscen %in% c("TechnologyAdvancesXH2a",
                                                                                     "TechnologyAdvancesXCNFa",
                                                                                     "MediumAll") |
                                           `Fuel Type` == "LH2 FCET" & ACEAscen %in% c("TechnologyAdvancesXH2a",
                                                                                       "TechnologyAdvancesXCNFa",
                                                                                       "MediumAll") |
                                           `Fuel Type` == "BET Mid" & ACEAscen %in% c("TechnologyAdvancesXELEa",
                                                                                      "TechnologyAdvancesXCNFa",
                                                                                      "MediumAll") |
                                           `Fuel Type` == "BET Long" & ACEAscen %in% c("TechnologyAdvancesXELEa",
                                                                                       "TechnologyAdvancesXCNFa",
                                                                                      "MediumAll") |
                                           `Fuel Type` == "Diesel Mix" & ACEAscen %in% c("TechnologyAdvancesXELEa",
                                                                                       "TechnologyAdvancesXCNFa",
                                                                                       "MediumAll")]

#Renaming scenarios
TCOdrivingProfiles[`Fuel Type` %in%  c("CH2 FCET", "LH2 FCET") & ACEAscen == "TechnologyAdvancesXH2a", ACEAscen := "Rather optimistic"]
TCOdrivingProfiles[`Fuel Type` %in%  c("CH2 FCET", "LH2 FCET") & ACEAscen == "TechnologyAdvancesXCNFa", ACEAscen := "Rather pessimistic"]

TCOdrivingProfiles[`Fuel Type` %in%  c("BET Mid", "BET Long") & ACEAscen == "TechnologyAdvancesXELEa", ACEAscen := "Rather optimistic"]
TCOdrivingProfiles[`Fuel Type` %in%  c("BET Mid", "BET Long") & ACEAscen =="TechnologyAdvancesXCNFa", ACEAscen := "Rather pessimistic"]
TCOdrivingProfiles[`Fuel Type` %in%  c("Diesel Mix") & ACEAscen == "TechnologyAdvancesXELEa", ACEAscen := "Rather pessimistic"]
TCOdrivingProfiles[`Fuel Type` %in%  c("Diesel Mix") & ACEAscen =="TechnologyAdvancesXCNFa", ACEAscen := "Rather optimistic"]
TCOdrivingProfiles[ACEAscen =="MediumAll", ACEAscen := "Medium"]
TCOdrivingProfiles  <- dcast(
  TCOdrivingProfiles,
  period + Country +`Fuel Type`+ `Vehicle Size` + paperScen + AM ~ ACEAscen,
  value.var = "value"
)


```

```{r, fig.width=14, fig.height=10, fig.fullwidth=FALSE}


yr <- c(2030)
trucktechs <- c("BET Long", "BET Mid", "Diesel Mix")
focusCountry <- "DE"
vehicleSize <- "Rigid"
data <- copy(TCOdrivingProfiles)[period %in% yr & `Fuel Type` %in% trucktechs & Country == focusCountry & `Vehicle Size` == vehicleSize]
data <- data[AM > 6000]

data_wide <- dcast(
  data,
  paperScen + AM ~ `Fuel Type`,
  value.var = "Medium"
)

find_intersections <- function(dt, col1, col2) {
  dt[, diff := get(col1) - get(col2)]
  dt[, sign_change := shift(sign(diff), type = "lag") != sign(diff)]
  dt[sign_change == TRUE, .(paperScen, AM, TCO = get(col2), `Fuel Type` = col1)]
}

# Find intersections
inter1 <- find_intersections(data_wide, "BET Long", "Diesel Mix")
inter2 <- find_intersections(data_wide, "BET Mid", "Diesel Mix")

# Combine results
intersections <- rbind(inter1, inter2)
intersections <- intersections[AM >10000]
#data[`Rather pessimistic` > 6, `Rather pessimistic` := 6]
#data[`Rather optimistic` > 6, `Rather optimistic` := 6]
#data[Medium > 6, Medium := 6]

ggplot(data) +
  geom_ribbon(
  aes(x = AM, ymin = `Rather optimistic`, ymax = `Rather pessimistic`, fill =  `Fuel Type`),
  inherit.aes = FALSE,
  alpha = 0.2
) +
  geom_line(aes(x = AM, y = Medium, color = `Fuel Type`), linewidth = 1) +
  
  geom_point(
  data = intersections,
  aes(x = AM, y = TCO),
  shape = 1, size = 6, stroke = 2, fill = NA, color = "black"
) +
geom_vline(
  data = intersections,
  aes(xintercept = AM, color = `Fuel Type`),
  linetype = "dashed", linewidth = 1
) +
  facet_grid2(
    rows = vars(paperScen),
    cols = NA,
    scales = "free_y",
    axes = "all"  # <- this makes all axes (x and y) visible
  ) +
  labs(
    x = "Annual mileage",
    y = "TCO",
    title = paste0("TCO over annual mileage\n", yr, " | ", focusCountry, " | ", vehicleSize, " trucks"))+
  coord_cartesian(ylim = c(0, 6))+ 
  scale_x_continuous(limits = c(6000, 100000)) +
  
  scale_color_manual(values = c("BET Mid" = "#1F77B4", "BET Long" = "#9467BD", "Diesel Mix" = "black"),
                     breaks = c("Diesel Mix", "BET Long", "BET Mid")) +  # Reorder the legend items

  scale_fill_manual(values = c("BET Mid" = "#1F77B4", "BET Long" = "#9467BD", "Diesel Mix" = "black"),
                    breaks = c("Diesel Mix", "BET Long", "BET Mid")) +  # Reorder the legend items
  theme(
    plot.title = element_text(size = 22, face = "bold", hjust = 0.5),
    plot.caption = element_text(size = 14, hjust = 0),
    axis.title.x = element_text(size = 18, margin = margin(t = 12)),
    axis.title.y = element_text(size = 18, margin = margin(r = 12)),
    axis.text = element_text(size = 14, color = "black"),
    axis.ticks = element_line(color = "black", size = 0.5),
    axis.line = element_line(color = "black", size = 0.8),
    
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 16),
    legend.position = "bottom",
    
    strip.text = element_text(
      size = 20,
      face = "bold",
      color = "black",
      margin = margin(t = 6, b = 6)  # Add breathing room
    ),
    strip.background = element_rect(
      fill = "#F5F5F5",  # Soft grey background, easy on the eyes
      color = NA         # No border
    ),
    panel.spacing = unit(1.2, "lines"),  # Extra space between facets
    
    
    panel.background = element_rect(fill = "white"),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "white")
  )

```







