---
title: "Enduse Energy Carrier Prices"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_document:
    toc: yes
    toc_depth: 2
---

<style type="text/css">

h1.title {
  font-size: 26px;
}
h1 { /* Header 1 */
  font-size: 22px;
}
h2 { /* Header 2 */
    font-size: 20px;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
}

</style>





```{r , include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  error = TRUE,
  message = FALSE)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)#
library(ggplot2)
library(data.table)
library(RColorBrewer)
library(ggtext)
library(ggh4x)
library(tibble)
# Get the directory of the currently running script or Rmd
folder_path <- dirname(this.path::this.dir())
```


```{r , include=FALSE}
fuelPricesEURperkwh <- fread(file.path(folder_path, "calcTCOData", "2_TCOdataFlexAM", "fuelPricesEURperkwh.csv"))


ZETfuels <- tribble(
  ~ElectricityMCS,                                  ~ElectricityCCS,                            ~Hydrogen, 
  "Electricity Price",                              "Electricity Price",                        "Hydrogen Price",
  "MCS Station (Public Charging) - Incl. Overhead", "CCS Station (Depot) - Incl. Overhead",     "HRS costs", 
  "MCS grid extension",                             "CCS grid extension",                       "",
  "MCS Profit and Mark-Up",                         "",                                         "HRS Overhead, Profit and Mark-Up",
  "Network Costs - MCS",                            "Network Costs - Depot",                    "H2 transport and distribution",
  "Taxes, Fees, Levies and charges - MCS",           "Taxes, Fees, Levies and charges - Depot", "Taxes, Fees, Levies and charges - H2",
  "",                                               "Depot - Network fees savings potential",   "",
) |> as.data.table()

convfuels <- tribble(
  ~DieselMix,                ~Biodiesel,                ~SyntheticDiesel,                          ~FossilDiesel,
  "Diesel Mix Price",         "Biodiesel Price",         "Pt-Diesel Price",                          "Diesel Price",
  "CO2 Tax Diesel Mix",       "CO2 Tax Biodiesel",       "CO2 Tax Pt-Diesel",                        "CO2 Tax Diesel",
  "Total Diesel Mark-Up",     "Total Diesel Mark-Up",    "Total Diesel Mark-Up",                     "Total Diesel Mark-Up",
  "Excise Duty - Diesel Mix", "Excise Duty - biodiesel", "Excise Duty - Synthetic Diesel (E-Fuels)", "Excise Duty - Diesel"
) |> as.data.table()

ElecMCS <- fuelPricesEURperkwh[Parameter %in% ZETfuels$ElectricityMCS & `Fuel-Scenario` %in% c("Electricity", "Hydrogen")][, Fuel := "Electricity MCS"]
ElecMCS[`Fuel-Scenario` %in% c("Electricity"), ACEAscen := "Rather optimistic"]
ElecMCS[`Fuel-Scenario` %in% c("Hydrogen"), ACEAscen := "Medium"]
ElecCCS <- fuelPricesEURperkwh[Parameter %in% ZETfuels$ElectricityCCS & `Fuel-Scenario` %in% c("Electricity", "Hydrogen")][, Fuel := "Electricity CCS"]
ElecCCS[`Fuel-Scenario` %in% c("Electricity"), ACEAscen := "Rather optimistic"]
ElecCCS[`Fuel-Scenario` %in% c("Hydrogen"), ACEAscen := "Medium"]
Hydrogen <- fuelPricesEURperkwh[Parameter %in% ZETfuels$Hydrogen & `Fuel-Scenario` %in% c("Electricity", "Hydrogen")][, Fuel := "Hydrogen"]
Hydrogen[`Fuel-Scenario` %in% c("Electricity"), ACEAscen := "Rather optimistic"]
Hydrogen[`Fuel-Scenario` %in% c("Hydrogen"), ACEAscen := "Medium"]

DieselMix <- fuelPricesEURperkwh[Parameter %in% convfuels$DieselMix & `Fuel-Scenario` %in% c("Low Carbon Fuels", "Hydrogen")][, Fuel := "Diesel Mix"]
DieselMix[`Fuel-Scenario` %in% c("Low Carbon Fuels"), ACEAscen := "Rather optimistic"]
DieselMix[`Fuel-Scenario` %in% c("Hydrogen"), ACEAscen := "Medium"]
Biodiesel <- fuelPricesEURperkwh[Parameter %in% convfuels$Biodiesel & `Fuel-Scenario` %in% c("Low Carbon Fuels", "Hydrogen")][, Fuel := "Biodiesel"]
Biodiesel[`Fuel-Scenario` %in% c("Low Carbon Fuels"), ACEAscen := "Rather optimistic"]
Biodiesel[`Fuel-Scenario` %in% c("Hydrogen"), ACEAscen := "Medium"]
SyntheticDiesel <- fuelPricesEURperkwh[Parameter %in% convfuels$SyntheticDiesel & `Fuel-Scenario` %in% c("Low Carbon Fuels", "Hydrogen")][, Fuel := "Synthetic diesel"]
SyntheticDiesel[`Fuel-Scenario` %in% c("Low Carbon Fuels"), ACEAscen := "Rather optimistic"]
SyntheticDiesel[`Fuel-Scenario` %in% c("Hydrogen"), ACEAscen := "Medium"]
FossilDiesel <- fuelPricesEURperkwh[Parameter %in% convfuels$FossilDiesel & `Fuel-Scenario` %in% c("Low Carbon Fuels", "Hydrogen")][, Fuel := "Fossil diesel"]
FossilDiesel[`Fuel-Scenario` %in% c("Low Carbon Fuels"), ACEAscen := "Rather optimistic"]
FossilDiesel[`Fuel-Scenario` %in% c("Hydrogen"), ACEAscen := "Medium"]


fuels <- rbind(ElecMCS, ElecCCS, Hydrogen, DieselMix, Biodiesel, SyntheticDiesel, FossilDiesel)

fuels[Parameter == "Hydrogen Price", Parameter := "Wholesale Hydrogen Price"]
fuels[Parameter == "Electricity Price", Parameter := "Wholesale Electricity Price"]
fuels[Parameter == "Diesel Mix Price", Parameter := "Wholesale Diesel Price (Mix)"]
fuels[Parameter == "Biodiesel Price", Parameter := "Wholesale Bioiesel Price"]
fuels[Parameter == "Pt-Diesel Price", Parameter := "Wholesale Synthetic Diesel Price"]
fuels[Parameter == "Diesel Price", Parameter := "Wholesale Diesel Price"]

#colorbar <- c('#99916b', '#e8d579', '#bab473', '#ebb491', '#e37552', '#a64728', '#6b1d1d')
shape_map <- c("Medium" = 3, "Rather optimistic" = 1)

Markup <- '#99916b'
CO2Tax <- '#e8d579'
GridExten <- '#bab473'
Charger <- '#ebb491'
otherTax <- '#e37552'
NetworkCost <- '#a64728'
EC_price <- '#6b1d1d'

colorbarHydrogen <- c(Markup, Charger, otherTax,  NetworkCost,  EC_price)
colorbarElec_MCS <- c(Markup, GridExten, Charger,otherTax, NetworkCost, EC_price)
colorbarElec_CCS <- c(GridExten, Charger,otherTax, NetworkCost, EC_price)
colorbarDie <- c(Markup, CO2Tax, otherTax, EC_price)
colorbarLNG <- c(Markup, CO2Tax, otherTax, EC_price)

# textSize <- 35

```

# Germany
## Hydrogen Enduse Prices [EUR/kWh]

```{r , include=TRUE, fig.width = 30,fig.height = 30}

data <- fuels[Fuel == "Electricity MCS" & paperScen == "Current Policies" & period %in% c(2030, 2040, 2050)]

# Filter and prep data
data[, identifier := ACEAscen]  # Create identifier column for plotting

# Create a grouped x-position: year spacing * offset + scenario within year
data[, identifier := factor(identifier)]
identifier_levels <- levels(data$identifier)

# Set grouping logic
data[, period := as.integer(period)]
setorder(data, period, identifier)

# Define numeric positions for custom spacing
gap_between_years <- 0.3
gap_within_year <- 1

# Assign position per identifier within each period
data[, id_idx := as.integer(factor(identifier, levels = identifier_levels))]
data[, xpos := (period - min(period)) * gap_between_years + id_idx * gap_within_year]

# Plot
p <- ggplot(data, aes(x = xpos, y = value, fill = Parameter)) +
  geom_col(position = "stack", width = 0.8) +
  # Add shape markers at the bottom for ACEAscen with legend
  geom_point(
  aes(y = -0.05 * max(data$value), shape = identifier),
  size = 4,                  # bigger shape
  fill = "black",            # visible fill (if using filled shapes like 21)
  color = "black",
  stroke = 1.2               # optional outline thickness
)+
  scale_shape_manual(name = "Scenario", values = shape_map)+
  scale_fill_manual(values = colorbar, name = "Parameter") +
  scale_x_continuous(
    breaks = data[, .(xpos = mean(xpos)), by = period]$xpos,
    labels = data[, .(xpos = mean(xpos)), by = period]$period
  ) +
  labs(
    x = "Year",
    y = "Hydrogen Price [EUR/kWh]"
  ) +
  theme_minimal() +
  facet_wrap(~ Country)+
   theme(
    plot.title = element_text(size = 22, face = "bold", hjust = 0.5),
    plot.caption = element_text(size = 14, hjust = 0),
    axis.title.x = element_text(size = 18, margin = margin(t = 12)),
    axis.title.y = element_text(size = 18, margin = margin(r = 12)),
    axis.text = element_text(size = 14, color = "black"),
    axis.ticks = element_line(color = "black", size = 0.5),
    axis.line = element_line(color = "black", size = 0.8),

    # Panel border and visibility for all facets
    panel.border = element_rect(color = "black", fill = NA, size = 0.8),
    panel.spacing = unit(1.2, "lines"),  # Space between facets
    panel.grid = element_blank(),  # Remove grid lines

    legend.title = element_text(size = 18),
    legend.text = element_text(size = 16),
    legend.position = "bottom",

    # Facet settings
    strip.text = element_text(
      size = 20,
      face = "bold",
      color = "black",
      margin = margin(t = 6, b = 6)  # Add breathing room
    ),
    strip.background = element_rect(
      fill = "#F5F5F5",  # Soft grey background
      color = NA         # No border
    ),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"),

    # Force x-axis to be drawn in every facet
    axis.text.x = element_text(size = 14, color = "black"),  # Make sure x-axis text is visible
    axis.ticks.x = element_line(color = "black", size = 0.5)  # Ensure x-axis ticks are visible
  )

print(p)

```

```{r, fig.width=16, fig.height=10, fig.fullwidth=FALSE}
# Get full combination of countries and all period values
data <- fuels[paperScen == "Current Policies" & period %in% c(2025, 2030, 2040, 2050)]
data <- unique(data[, c("Country", "period", "Fuel", "paperScen", "ACEAscen", "Parameter", "value")])
data <- data[, .(value = sum(value)), by = c("Country", "period", "Fuel", "paperScen", "ACEAscen")]
setnames(data, c("ACEAscen"), c("Sensitivity scenario"))



p <- ggplot(
  data[Fuel == "Hydrogen"], 
  aes(color = Fuel, linetype = `Sensitivity scenario`)
) +
  geom_line(aes(x = period, y = value), linewidth = 0.8) +
  
  # Facet settings: No spacing & fixed scales
  facet_wrap(~ Country, ncol = 3, scales = "fixed") +  
  
  # Title and labels
  labs(
    x = "Year",
    y = "Fuel price [EUR/kWh]",
    title = "Enduse Fuel prices incl. mark-ups and taxes") +
  coord_cartesian(ylim = c(0, 1))+ 

  # Theme modifications
  theme(
    plot.title = element_text(size = 22, face = "bold", hjust = 0.5),
    plot.caption = element_text(size = 14, hjust = 0),
    axis.title.x = element_text(size = 18, margin = margin(t = 12)),
    axis.title.y = element_text(size = 18, margin = margin(r = 12)),
    axis.text = element_text(size = 14, color = "black"),
    axis.ticks = element_line(color = "black", size = 0.5),
    axis.line = element_line(color = "black", size = 0.8),

    # Panel border and visibility for all facets
    panel.border = element_rect(color = "black", fill = NA, size = 0.8),
    panel.spacing = unit(1.2, "lines"),  # Space between facets
    panel.grid = element_blank(),  # Remove grid lines

    legend.title = element_text(size = 18),
    legend.text = element_text(size = 16),
    legend.position = "bottom",

    # Facet settings
    strip.text = element_text(
      size = 20,
      face = "bold",
      color = "black",
      margin = margin(t = 6, b = 6)  # Add breathing room
    ),
    strip.background = element_rect(
      fill = "#F5F5F5",  # Soft grey background
      color = NA         # No border
    ),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"),

    # Force x-axis to be drawn in every facet
    axis.text.x = element_text(size = 14, color = "black"),  # Make sure x-axis text is visible
    axis.ticks.x = element_line(color = "black", size = 0.5)  # Ensure x-axis ticks are visible
  )
plot(p)
dir <- dirname(getwd())
ggsave(file.path(dir, "plots", paste0("BreakevenPlot.svg")), plot = p, device = "svg", width = 27, height = 9, units = "in")


```





## Hydrogen Enduse Prices [EUR/kg]
```{r , include=TRUE, fig.width = 30,fig.height = 10}
HydrogenKg <- copy(Hydrogen)
HydrogenKg[, `kWh/kg H2` := 33.33]
HydrogenKg[, value := value*`kWh/kg H2`][, unit := "EUR/kg"]

p <- ggplot(HydrogenKg[Country %in% Countries_plotted & period %in% yrs], aes(fill=Parameter, y=value, x=`period`)) + theme(panel.grid.major=element_line(colour='#adadad'), panel.grid.minor=element_line(colour='#adadad')) +
    geom_bar(position="stack", stat="identity")+
      facet_grid(~ `Fuel-Scenario`, scales = "free")+
      theme(text = element_text(size = textSize))+
      labs(y = paste0("Hydrogen Price [EUR/kg]")) + #, title = "Hydrogen Prices for different Fuel Scenarios") +
      scale_x_continuous(breaks = c(2030, 2040, 2050)) +
      scale_fill_manual(values=colorbarHydrogen)
plot(p)

```

