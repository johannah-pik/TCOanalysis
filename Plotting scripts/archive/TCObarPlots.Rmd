---
title: "TCObarPlots"
author: "Johanna Hoppe"
date: "2025-02-21"
output: html_document
---

```{r , include=FALSE}
library(data.table)
library(ggplot2)
library(knitr)
library(RColorBrewer)
library(this.path)
library(ggsignif)
library(ggpubr)
library(patchwork)
library(dplyr)
library(tidyr)
# Get the directory of the currently running script or Rmd
folder_path <- dirname(this.path::this.dir())
```

```{r , include=FALSE}
plotData <- fread(file.path(folder_path, "calcTCOData", "3_ScenarioSpecificTCOdataFlexAM", "TCO_ACEAscen.csv"))

AnnualMileage <- data.table(`Vehicle Size`= c("Rigid", "Rigid", "Rigid", "Tractor-Trailer", "Tractor-Trailer", "Tractor-Trailer"),
                            "Operation" = c("Urban", "Regional", "Long-haul", "Urban", "Regional", "Long-haul"),
                            "AM" = c(30000, 85000, 140000, 40000, 90000, 160000))

plotData <- merge(plotData, AnnualMileage, by = c("Vehicle Size"), allow.cartesian = TRUE)
plotData[Unit == "EUR/veh yr", value := value/AM][, AM := NULL]
plotData[Unit == "EUR/veh yr", Unit := "EUR/km"]

paperScenario <- "Default"
plotData <- plotData[paperScen == paperScenario][, paperScen := NULL]
groupParameters <- TRUE
source(file.path(folder_path, "Plotting scripts", "PrepareTCOdataForPlotting.R"))
TCO_plotting <- plotData
```

```{r , include=FALSE}
plotData <- fread(file.path(folder_path, "calcTCOData", "3_ScenarioSpecificTCOdataFlexAM", "TCO_ACEAscen.csv"))

AnnualMileage <- data.table(`Vehicle Size`= c("Rigid", "Rigid", "Rigid", "Tractor-Trailer", "Tractor-Trailer", "Tractor-Trailer"),
                            "Operation" = c("Urban", "Regional", "Long-haul", "Urban", "Regional", "Long-haul"),
                            "AM" = c(30000, 85000, 140000, 40000, 90000, 160000))

plotData <- merge(plotData, AnnualMileage, by = c("Vehicle Size"), allow.cartesian = TRUE)
plotData[Unit == "EUR/veh yr", value := value/AM][, AM := NULL]
plotData[Unit == "EUR/veh yr", Unit := "EUR/km"]

paperScenario <- "Urban depot charging"
plotData <- plotData[paperScen == paperScenario][, paperScen := NULL]
groupParameters <- TRUE
source(file.path(folder_path, "Plotting scripts", "PrepareTCOdataForPlotting.R"))
TCODefault <- copy(TCO_plotting)[, paperScen := "Default"]
TCO_paperScen <- rbind(TCODefault, plotData[, paperScen := paperScenario])
```


```{r, fig.width=18, fig.height=4, fig.fullwidth=FALSE}
# Select plot data
yrs <- c(2030)
countryanalysed <- "DE"
ACEA <- "MediumAll"
vehSize <- "Tractor-Trailer"
operationMode <- c("Long-haul", "Urban")
trucktechs <- c("BET Long", "CH2 FCET", "Diesel Mix")

TCOdata <- TCO_plotting[period %in% yrs & Country %in% countryanalysed & `Fuel Type` %in% trucktechs & ACEAscen %in% ACEA & `Vehicle Size` %in% vehSize & Operation %in% operationMode]
TCOdata[, `Fuel Type` := factor(`Fuel Type`, levels = c("CH2 FCET", "BET Long", "Diesel Mix"))]
# specific calculations for this plot
# Compute CAPEX and OPEX shares using data.table
data_summary <- TCOdata[, .(
  CAPEX = sum(value[Parameter %in% c("Battery", "Vehicle body incl. engine")]),
  OPEX = sum(value[!(Parameter %in% c("Battery", "Vehicle body incl. engine"))]),
  total_tco = sum(value)
), by = .(Operation, `Fuel Type`)]  # Group by both Operation & Fuel Type

# Calculate CAPEX & OPEX share as a percentage of total TCO
data_summary[, CAPEX := round(100 * CAPEX / total_tco, 1)]
data_summary[, OPEX := round(100 * OPEX / total_tco, 1)]
data_summary <- melt(data_summary, 
                            id.vars = c("Operation", "Fuel Type", "total_tco"),  # Keep the ID columns as is
                            measure.vars = c("CAPEX", "OPEX"),  # Melt capex and opex columns
                            variable.name = "cost  category",  # Name of the new column for cost type
                            value.name = "share")
data_summary[, `cost category` := factor(`cost  category`, levels = c("OPEX", "CAPEX"))]
data_summary[, labelPos := cumsum(share), by = .(Operation, `Fuel Type`)]
data_summary[, `Fuel Type` := factor(`Fuel Type`, levels = c("CH2 FCET", "BET Long", "Diesel Mix"))]
# Stacked Bar Plot
g1 <- ggplot(TCOdata, aes(x = Operation)) +
  geom_bar(aes(y = value, fill = Parameter), position = "stack", stat = "identity", width = 0.8) +
  scale_fill_manual(values = ParameterColors) + 
  facet_wrap(~ `Fuel Type`) +
  labs(x = "", y = "TCO [EUR/Vehkm]", title = paste(vehSize, "in", yrs)) +
  scale_x_discrete(labels = function(x) { sub("\\s", "\n", x) }) +
  theme(
    panel.grid.major = element_line(colour = '#adadad'), 
    panel.grid.minor = element_line(colour = '#adadad'),
    aspect.ratio = 1.25,
    text = element_text(size = 14),  # General text size
    axis.title = element_text(size = 14),  # Axis title size
    axis.text = element_text(size = 14, color = "black"),  # Axis labels size
    # Adjust facet labels size
    strip.text = element_text(size = 14),
    
    # Adjust legend text size
    legend.key.size = unit(0.7, "cm"),  # Legend key size
    legend.text = element_text(size = 10),  # Legend text size
    legend.title = element_blank()  # Legend title size
  )
g2 <- ggplot(data_summary, aes(x = Operation)) +
  geom_bar(aes(y = share, fill = `cost category`), position = "stack", stat = "identity", width = 0.8) +
  facet_wrap(~ `Fuel Type`) +
  labs(x = "", y = "Share (%)") +
  scale_x_discrete(labels = function(x) { sub("\\s", "\n", x) }) +
  scale_fill_manual(values = c("OPEX" = "#FFC325", "CAPEX" = "#003366")) +  # Adjust colors for better clarity
  theme(
    panel.grid.major = element_line(colour = '#adadad'), 
    panel.grid.minor = element_line(colour = '#adadad'),
    aspect.ratio = 1.25,
    text = element_text(size = 14),  # General text size
    axis.title = element_text(size = 14),  # Axis title size
    axis.text = element_text(size = 14, color = "black"),  # Axis labels size
    # Adjust facet labels size
    strip.text = element_text(size = 14),
    
    # Adjust legend text size
    legend.key.size = unit(0.7, "cm"),  # Legend key size
    legend.text = element_text(size = 10),  # Legend text size
    legend.title = element_blank()  # Legend title size
  ) +
  
  # Add text labels for share values
  geom_label(aes(y = share, label = paste0(share, "%")), 
            position = position_stack(vjust = 0.5), 
            color = "black", 
            size = 5, 
            fontface = "bold",
            fill = scales::alpha("white", 0.8),  # White background
            label.size = 0.0,   # No border around the label
            label.padding = unit(0.2, "lines"),  # Adjust padding around the text
            label.r = unit(0.5, "lines")) +  # Customize the appearance of labels
  
  # Move the y-axis to the right side
  scale_y_continuous(position = "right")

plot(g1 + g2)
```

```{r, fig.width=18, fig.height=4, fig.fullwidth=FALSE}
# Select plot data
yrs <- c(2030)
countryanalysed <- "DE"
ACEA <- "MediumAll"
vehSize <- "Rigid"
operationMode <- c("Urban")
trucktechs <- c("BET Mid", "Diesel Mix")


TCOdata <- TCO_paperScen[period %in% yrs & Country %in% countryanalysed & `Fuel Type` %in% trucktechs & ACEAscen %in% ACEA & `Vehicle Size` %in% vehSize & Operation %in% operationMode]
TCOdata[, `Fuel Type` := factor(`Fuel Type`, levels = c("BET Mid", "Diesel Mix"))]

# Stacked Bar Plot
g1 <- ggplot(TCOdata, aes(x = paperScen)) +
  geom_bar(aes(y = value, fill = Parameter), position = "stack", stat = "identity", width = 0.8) +
  scale_fill_manual(values = ParameterColors) + 
  facet_wrap(~ `Fuel Type`) +
  labs(x = "", y = "TCO [EUR/Vehkm]", title = paste(vehSize, "in", yrs)) +
  scale_x_discrete(labels = function(x) { sub("\\s", "\n", x) }) +
  theme(
    panel.grid.major = element_line(colour = '#adadad'), 
    panel.grid.minor = element_line(colour = '#adadad'),
    aspect.ratio = 1.25,
    text = element_text(size = 14),  # General text size
    axis.title = element_text(size = 14),  # Axis title size
    axis.text = element_text(size = 14, color = "black"),  # Axis labels size
    # Adjust facet labels size
    strip.text = element_text(size = 14),
    
    # Adjust legend text size
    legend.key.size = unit(0.7, "cm"),  # Legend key size
    legend.text = element_text(size = 10),  # Legend text size
    legend.title = element_blank()  # Legend title size
  )

plot(g1)
```

```{r, fig.width=15, fig.height=4, fig.fullwidth=FALSE}
# Select plot data
yrs <- c(2030)
countryanalysed <- "DE"
ACEA <- "MediumAll"
vehSize <- "Rigid"
operationMode <- c("Regional")
trucktechs <- c("CH2 FCET", "Diesel Mix")
altTechs <- c("BET Long", "BET Mid", "CH2 FCET", "LH2 FCET")

TCOdata2 <- TCO_plotting[period %in% yrs & Country %in% countryanalysed & `Fuel Type` %in% trucktechs & ACEAscen %in% ACEA & `Vehicle Size` %in% vehSize & Operation %in% operationMode]
TCOdata2[, `Fuel Type` := factor(`Fuel Type`, levels = c("Diesel Mix", "CH2 FCET"))]

#Add inconvenience cost
incoCost <- TCOdata2[Parameter == "Vehicle body incl. engine"]
incoCost[!`Fuel Type` %in% altTechs, value := 0]
incoCost[`Fuel Type` %in% altTechs, value := value * 0.3]
incoCost[, Parameter := "Inconvenience cost"]
TCOdata2 <- rbind(TCOdata2, incoCost)
#Include into factors and colors
TCOdata2[, Parameter := factor(Parameter, 
                                   levels = c( "Inconvenience cost",
                                               "CO2 tax",
                                               "Toll charge", 
                                               "Other taxes", 
                                               "Network Costs", 
                                               "Charging/refueling infrastructure", 
                                               "Fuel cost", 
                                               "M&R + Tires specific costs",  
                                               "Tank" , 
                                               "Fuel cell system", 
                                               "Battery", 
                                               "Vehicle body incl. engine" ))]

ParameterColors <- c(
  "Inconvenience cost" = '#53369c',
  ParameterColors
)

# Define the wavy line function
s_curve <- function(xmin, xmax, y) {
  x_seq <- seq(xmin, xmax, length.out = 100)
  y_seq <- y + 0.015 * sin(seq(0, 2 * pi, length.out = 100))  # Sine wave for wavy effect
  data.frame(x = x_seq, y = y_seq)
}

TCOdata2_adjusted <- TCOdata2 %>%
  mutate(Operation = factor(Operation),  
         value = ifelse(Parameter == "Inconvenience cost", value * 0.98, value))  

# Create wavy line data for each "Operation"
wavy_lines <- TCOdata2 %>%
  group_by(Operation, `Fuel Type`) %>%
  summarise(ymax = sum(value)) %>%
  rowwise() %>%
  mutate(curve = list(s_curve(as.numeric(factor(Operation)) - 0.4, as.numeric(factor(Operation)) + 0.4, ymax))) %>%
  unnest(curve)
wavy_lines <- as.data.table(wavy_lines)
wavy_lines[`Fuel Type` == "Diesel Mix", c("ymax", "x", "y") := 0]

# Define transparent box data (for "Inconvenience cost" bars)
box_data <- TCOdata2_adjusted %>%
  group_by(Operation, `Fuel Type`) %>%
  summarise(ymin = sum(value) * 0.95,  # Start slightly below the bar
            ymax = sum(value) * 1.1,  # Extend slightly above
            .groups = "drop") %>%
  mutate(xmin = as.numeric(factor(Operation)) - 0.4,  
         xmax = as.numeric(factor(Operation)) + 0.4)
box_data <- as.data.table(box_data)
box_data[`Fuel Type` == "Diesel Mix", c("ymax", "ymin", "xmin", "xmax") := 0]


# Plot with adjusted bar heights + wavy lines
g1 <- ggplot(TCOdata2_adjusted, aes(x = Operation)) +
  geom_bar(aes(y = value, fill = Parameter), position = "stack", stat = "identity", width = 0.8) +
  scale_fill_manual(values = ParameterColors) + 
  facet_wrap(~ `Fuel Type`) +
  geom_rect(data = box_data, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), 
            fill = '#53369c', alpha = 0.3) +
  geom_line(data = wavy_lines, aes(x = x, y = y, group = Operation), color = '#E5E5E5', linewidth = 1.1) +  # Add wavy line
  labs(x = "", y = "TCO [EUR/Vehkm]", title = paste(vehSize, "in", yrs)) +
  scale_x_discrete(labels = function(x) { sub("\\s", "\n", x) }) +
  theme(
    panel.grid.major = element_line(colour = '#adadad'), 
    panel.grid.minor = element_line(colour = '#adadad'),
    aspect.ratio = 1.25,
    text = element_text(size = 14),  
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 14, color = "black"),  
    strip.text = element_text(size = 14),  
    legend.key.size = unit(0.7, "cm"),  
    legend.text = element_text(size = 14),  
    legend.title = element_blank(),  
    panel.spacing = unit(0, "cm")
  ) +
  scale_y_continuous(position = "right")

plot(g1)

```