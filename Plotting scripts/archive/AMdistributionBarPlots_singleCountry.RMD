---
title: "Annual mileage distribution plots EUR"
author: "Johanna Hoppe"
date: "2025-02-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)#
library(ggplot2)
library(data.table)
library(RColorBrewer)
library(ggtext)
library(ggh4x)
#Insert pth to mileage data
AMdataPath <- "C:/Users/johannah/Documents/Paper/TCO/ISI driving profiles/export_veh_km.csv"
# Get the directory of the currently running script or Rmd
folder_path <- dirname(this.path::this.dir())
```

```{r}

# Apply mileage data on TCO (using bins to split mileage data)
# Calculate TCOgap compared to Diesel-mix for each bin
# Prepare data for plotting
#Variablen:
#“vehicleid" = FahrzeugNr. Beginnt mit Jahr der Erhebung
#"GKtype" = Größenklasse
#"country" = Land (nur unsere sieben behnalten hierfür)
#"weekkm" = Summe der Wege-km in einer Woche (bei DE nur halb woche aufgezeichenet, daher für vergleichbarkeit schon mal zwei genommen)
#"N" = Anzahl Wege des Fahrzeuges in der Woche
#"avkt" = Jahresfahrleistung = Wochen-km*52

# Sort AM data
AMdata <- fread(file = AMdataPath, header = TRUE, sep = ",", dec=".")
AMdata[, V1 := NULL]
AMdata[, period := substr(vehicleid, 1, 4)]
AMdata[, avkt := as.numeric(avkt)]
setnames(AMdata, "GKtype", "Vehicle Size")
AMdata[`Vehicle Size` == "tractor-trailer", `Vehicle Size` := "Tractor-Trailer"]
AMdata[`Vehicle Size` == "rigid", `Vehicle Size` := "Rigid"]
setnames(AMdata, "country", "Country")

AMdata <- AMdata[!(`Vehicle Size` == "other" | Country == "SE")]

# Split AM data into equally sized bins
# Define global bin breaks based on the entire dataset
global_breaks <- seq(min(AMdata$avkt, na.rm = TRUE), max(AMdata$avkt, na.rm = TRUE), length.out = 201)

# Apply the same breaks to all groups
AMdata[, avkt_binned := cut(avkt, breaks = global_breaks, include.lowest = TRUE)]
# Calculate mean annual mileage for each bin
AMdata[, binMean := mean(avkt), by = c("avkt_binned", "Vehicle Size", "Country")]
# Calculate total yearly road km for each bin 
AMdata <- AMdata[, .(totRoadkm = sum(avkt)), by = c("Country", "Vehicle Size", "avkt_binned", "binMean")]
# Calculate total road km for each Country
AMdata[, totRoadkmCountry := sum(totRoadkm), by = "Country"]
# Calculate share of each bin in the total yearly road km in each Country 
AMdata[, shareKmCountry := totRoadkm/totRoadkmCountry]
```

```{r}
plotData <- fread(file.path(folder_path, "calcTCOData", "3_ScenarioSpecificTCOdataFlexAM", "TCO_ACEAscen.csv"))
co2Price <- fread(file.path(folder_path, "calcTCOData", "2_TCOdataFlexAM", "CO2Price_currentPol.csv"))
co2PriceCurrentPol <- co2Price[paperScen == "Current Policies"] 
co2PriceCurrentPol <- unique(co2PriceCurrentPol[, c("period", "value")])
plotData <- plotData[paperScen %in% c("Current Policies", "Removed Policies", "Current Policies without CO2 Price")]

groupParameters <- FALSE
source(file.path(folder_path, "Plotting scripts", "PrepareTCOdataForPlotting.R"))
TCO_plotting <- plotData[, .(value = sum(value)), by = c("Country", "Vehicle Size", "Fuel Type", "ACEAscen", "paperScen", "Unit", "period")]

#OPEX and CAPEX still separated
TCOdrivingProfiles <- merge(TCO_plotting, AMdata, by = c("Country", "Vehicle Size"), allow.cartesian = TRUE)
TCOdrivingProfiles[Unit == "EUR/veh yr", value := value/binMean]
TCOdrivingProfiles[Unit == "EUR/veh yr", Unit := "EUR/km"]
#Sum up after unifying the unit
TCOdrivingProfiles <- TCOdrivingProfiles[, .(value = sum(value)), by = c("Country", "Vehicle Size", "Fuel Type", "ACEAscen", "paperScen", "Unit", "period", "avkt_binned", "shareKmCountry", "binMean")]

# Calculate TCO gap compared to Diesel Mix
DieselMix <- TCOdrivingProfiles[`Fuel Type` == "Diesel Mix"]
setnames(DieselMix, "value", "totDieselMix")
DieselMix <- unique(DieselMix[, c("Country", "Vehicle Size", "ACEAscen", "paperScen", "period", "totDieselMix", "avkt_binned")])

TCOdrivingProfiles <- TCOdrivingProfiles[!`Fuel Type` %in% c("Gas ICE", "Diesel Fossil", 
                                                             "Diesel Syn", "Diesel Bio", "Diesel Mix")]
TCOdrivingProfiles <- merge(TCOdrivingProfiles, DieselMix, by = c("Country", "Vehicle Size", "ACEAscen", "paperScen", "avkt_binned", "period"))
TCOdrivingProfiles[, TCOgap := value - totDieselMix][, totDieselMix := NULL]

#Co2 Intensities do not vary by paperScen
co2Intensities <- fread(file.path(folder_path, "calcTCOData", "3_ScenarioSpecificTCOdataFlexAM", "co2Intensities_ACEAscen.csv"))#tCO2/km
setnames(co2Intensities, "value", "co2int")
co2Intensities <- co2Intensities[`Fuel Type` == "Diesel Mix" ][, `Fuel Type` := NULL]
co2Intensities <- co2Intensities[`paperScen` == "Current Policies" ][, paperScen := NULL]
co2Intensities <- co2Intensities[, c("Country", "Vehicle Size", "ACEAscen", "period", "co2int")]
TCOdrivingProfiles <- merge(TCOdrivingProfiles, co2Intensities, by = intersect(names(TCOdrivingProfiles), names(co2Intensities)))

#Selecting the edge Scenarios
#Selecting the edge Scenarios
TCOdrivingProfiles <- TCOdrivingProfiles[`Fuel Type` == "CH2 FCET" & ACEAscen %in% c("TechnologyAdvancesXH2a",
                                                                                     "TechnologyAdvancesXCNFa",
                                                                                     "MediumAll") |
                                           `Fuel Type` == "LH2 FCET" & ACEAscen %in% c("TechnologyAdvancesXH2a",
                                                                                       "TechnologyAdvancesXCNFa",
                                                                                       "MediumAll") |
                                           `Fuel Type` == "BET Mid" & ACEAscen %in% c("TechnologyAdvancesXELEa",
                                                                                      "TechnologyAdvancesXCNFa",
                                                                                      "MediumAll") |
                                           `Fuel Type` == "BET Long" & ACEAscen %in% c("TechnologyAdvancesXELEa",
                                                                                       "TechnologyAdvancesXCNFa",
                                                                                       "MediumAll")]

#Renaming scenarios
TCOdrivingProfiles[`Fuel Type` %in%  c("CH2 FCET", "LH2 FCET") & ACEAscen == "TechnologyAdvancesXH2a", ACEAscen := "Optimistic"]
TCOdrivingProfiles[`Fuel Type` %in%  c("CH2 FCET", "LH2 FCET") & ACEAscen == "TechnologyAdvancesXCNFa", ACEAscen := "Pessimistic"]

TCOdrivingProfiles[`Fuel Type` %in%  c("BET Mid", "BET Long") & ACEAscen == "TechnologyAdvancesXELEa", ACEAscen := "Optimistic"]
TCOdrivingProfiles[`Fuel Type` %in%  c("BET Mid", "BET Long") & ACEAscen =="TechnologyAdvancesXCNFa", ACEAscen := "Pessimistic"]
TCOdrivingProfiles[ACEAscen =="MediumAll", ACEAscen := "Medium"]

gapCO2Price <- copy(TCOdrivingProfiles)
gapCO2Price[, Co2PriceToCloseGap := TCOgap/co2int]# EUR/km *km/tCO2
setorder(gapCO2Price, "Country", "Fuel Type", "period", "paperScen", "ACEAscen", "Co2PriceToCloseGap")
setorder(TCOdrivingProfiles, "Country", "Fuel Type",  "period", "paperScen","ACEAscen", "TCOgap")

TCOdrivingProfiles[, share := cumsum(shareKmCountry)*100, by = c("Country", "Fuel Type", "ACEAscen", "paperScen", "period")]
gapCO2Price[, share := cumsum(shareKmCountry)*100, by = c("Country", "Fuel Type", "ACEAscen", "paperScen", "period")]
```


```{r, fig.width=30, fig.height=20, fig.fullwidth=FALSE}
yr <- c(2030)
Country <- "DE"
trucktechs <- c("BET Long", "BET Mid", "CH2 FCET")
data <- copy(TCOdrivingProfiles)[period %in% yr & `Fuel Type` %in% trucktechs & Country %in% "DE"]
data[, cum_width := 0.999 * (share - shift(share, type = "lag")), by = c("paperScen", "ACEAscen", "Fuel Type")]
data[is.na(cum_width), cum_width := (share), by = c("paperScen", "ACEAscen", "Fuel Type")]

data[, paperScen := factor(paperScen, 
                               levels = c("Removed Policies", "Current Policies"))]
data[, ACEAscen := factor(ACEAscen, 
                               levels = c("Rather optimistic", "Medium", "Rather pessimistic"))]

# Cut highest and lowest data
data[TCOgap >= 0.7, TCOgap := 0.7]
data[TCOgap <= -0.9, TCOgap := -0.7]

findZeroPoints <-  data[ , .SD[which.min(abs(TCOgap))], by = .(period, `Fuel Type`, paperScen, ACEAscen)]
setorder(findZeroPoints, paperScen, ACEAscen, share)
findZeroPoints[, arrow_y := seq(-0.4, -0.6, length.out = .N), by = c("paperScen", "ACEAscen")]

setorder(findZeroPoints, - share)
data[, `Fuel Type` := factor(`Fuel Type`, levels = unique(findZeroPoints$`Fuel Type`))]
findZeroPoints[, `Fuel Type` := factor(`Fuel Type`, levels = unique(findZeroPoints$`Fuel Type`))]  
middle_y <- findZeroPoints[round(nrow(findZeroPoints)/6), arrow_y]

# Create the bar plot
p <- ggplot(data) +
  geom_segment(aes(
    x = abs(share - cum_width),  # Bar starts left of cum_shareKmEUR
    xend = share,              # Bar ends at cum_shareKmEUR
    y = TCOgap,                           # Bars start from the x-axis
    yend = TCOgap,                      # Bar height is determined by TCOgap
    color = `Fuel Type`,
  ),  linewidth = 0.8) +
  geom_rect(aes(
    xmin = share - cum_width,  
    xmax = share,              
    ymin = 0,                           
    ymax = TCOgap,                      
    fill = `Fuel Type`,  # Different colors for Fuel Types
    color = `Fuel Type`
  ),  linewidth = 0.02, alpha = 0.2) +  # Transparency for visibility
  scale_x_continuous(expand = c(0, 0), limits = c(0, 1.05 * max(data$share, na.rm = TRUE))) +
  scale_y_continuous(limits = c(-0.7, 0.7)) +
  labs(x = "Share of road km in EUR", y = "TCO gap", color = "Fuel Type") +
  
  # Manually define colors for the Fuel Type categories
  scale_color_manual(values = c("BET Mid" = "#1F77B4", "BET Long" = "#9467BD", "CH2 FCET" = "#E65C00"),
                     breaks = c("CH2 FCET", "BET Long", "BET Mid")) +  # Reorder the legend items

  scale_fill_manual(values = c("BET Mid" = "#1F77B4", "BET Long" = "#9467BD", "CH2 FCET" = "#E65C00"),
                    breaks = c("CH2 FCET", "BET Long", "BET Mid")) +  # Reorder the legend items
  
  # Use guides to customize the legend
  guides(
    color = guide_legend(order = 1),  # Order of color legend
    fill = guide_legend(order = 1)    # Order of fill legend
  ) +
  
  # Your existing plot elements (e.g., vertical dashed lines, arrows, etc.)
  geom_point(data = findZeroPoints, aes(x = share, y = 0), 
             shape = 1, size = 6, stroke = 2, fill = NA, color = "black") +
  geom_vline(data = findZeroPoints, aes(xintercept = share, color = `Fuel Type`), 
             linetype = "dashed", linewidth = 1) +
  geom_segment(data = findZeroPoints, aes(x = 0, xend = share, y = arrow_y, yend = arrow_y, color = `Fuel Type`), 
               arrow = arrow(length = unit(0.3, "cm"), type = "open"), 
               linewidth = 1) +
 geom_label(data = findZeroPoints, 
           aes(x = 20, y = arrow_y, 
               label = paste("~", round(share), "%")),
           color = "black", 
           fill = "white",  # Set the background color to white
           size = 8,  # Consistent text size
           fontface = "bold",  # Make the text bold
           label.padding = unit(0.2, "cm"),  # Adjust padding for a clean look
           label.size = 0,  # No border around the label
           hjust = 0.5, 
           vjust = 0.5) +
  annotate("label", x = 27, y = middle_y, label = "of road km cost beneficial", 
           color = "black", fill = "white", fontface = "bold", size = 6, hjust = 0, vjust = 0.5, 
           label.padding = unit(0.3, "cm"), label.size = 0) +
  geom_hline(yintercept = 0, color = "black", size = 0.8) +
  
 # Add facet for ACEscen with customizations
   # Use facet_grid2 with axes = "all" to show y-axis everywhere
  facet_grid2(
    rows = vars(paperScen),
    cols = vars(ACEAscen),
    scales = "free_y",
    axes = "all"  # <- this makes all axes (x and y) visible
  ) +
  labs(title = paste("Total cost of ownership gap between ZET and conventional diesel trucks in 2030"), 
        caption = paste("Figure 1| Total cost of ownership gap between ZET and conventional diesel trucks covering heterogenous cost and mileage profiles in key european truck markets and their respective share in the total road km\nfor rigid and tractor-trailer trucks.\na) Medium TCO cost projections for all technologies.\nb) Rather optimistic TCO projections for the zero-emission technology under consideration and rather pessimistic TCO cost projections for the compared conventional diesel truck.\nc) Rather pessimistic TCO projections for the zero-emission technology under consideration and rather optimisitc TCO cost projections for the compared conventional diesel truck.")) +
   theme(
    plot.title = element_text(size = 22, face = "bold", hjust = 0.5),
    plot.caption = element_text(size = 14, hjust = 0),
    axis.title.x = element_text(size = 18, margin = margin(t = 12)),
    axis.title.y = element_text(size = 18, margin = margin(r = 12)),
    axis.text = element_text(size = 14, color = "black"),
    axis.ticks = element_line(color = "black", size = 0.5),
    axis.line = element_line(color = "black", size = 0.8),
    
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 16),
    legend.position = "bottom",
    
    strip.text = element_text(
      size = 20,
      face = "bold",
      color = "black",
      margin = margin(t = 6, b = 6)  # Add breathing room
    ),
    strip.background = element_rect(
      fill = "#F5F5F5",  # Soft grey background, easy on the eyes
      color = NA         # No border
    ),
    panel.spacing = unit(1.2, "lines"),  # Extra space between facets
    
    
    panel.background = element_rect(fill = "white"),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "white")
  )

plot(p)
dir <- dirname(getwd())
ggsave(file.path(dir, "plots", paste0("AMdistributionBarPlotEUR_allPaperScen.svg")), plot = p, device = "svg", width = 27, height = 9, units = "in")


```



```{r, fig.width=30, fig.height=10, fig.fullwidth=FALSE}
yr <- c(2030)
trucktechs <- c("BET Long", "BET Mid")

data <- copy(gapCO2Price)[period %in% yr & `Fuel Type` %in% trucktechs & paperScen == "Current Policies" & ACEAscen == "Rather pessimistic"]
data[, ACEAscen := factor(ACEAscen, 
                               levels = c("Medium"))]
data[, cum_width := 0.999* (share - shift(share, type = "lag")), by = c("Country", "ACEAscen", "Fuel Type")]
data[is.na(cum_width), cum_width := (share), by = c("Country", "ACEAscen", "Fuel Type")]
co2PriceCurrentPol <- co2PriceCurrentPol[period %in% yr]
# Cut highest and lowest data
data[Co2PriceToCloseGap >= 1000, Co2PriceToCloseGap := 1000]

findZeroPoints <-  data[ , .SD[which.min(abs(Co2PriceToCloseGap))], by = .(period, `Fuel Type`, ACEAscen)]
setorder(findZeroPoints, ACEAscen, share)
findZeroPoints[, arrow_y := seq(-0.6, -0.9, length.out = .N), by = c("Country", "ACEAscen")]

setorder(findZeroPoints, - share)
data[, `Fuel Type` := factor(`Fuel Type`, levels = unique(findZeroPoints$`Fuel Type`))]
findZeroPoints[, `Fuel Type` := factor(`Fuel Type`, levels = unique(findZeroPoints$`Fuel Type`))]  
middle_y <- findZeroPoints[round(nrow(findZeroPoints)/6), arrow_y]

# Create the bar plot
p <- ggplot(data) +
  geom_segment(aes(
    x = abs(share - cum_width),  # Bar starts left of cum_shareKmEUR
    xend = share,              # Bar ends at cum_shareKmEUR
    y = Co2PriceToCloseGap,                           # Bars start from the x-axis
    yend = Co2PriceToCloseGap,                      # Bar height is determined by Co2PriceToCloseGap
    color = `Fuel Type`,
  ),  linewidth = 0.8) +
  geom_rect(aes(
    xmin = share - cum_width,  
    xmax = share,              
    ymin = 0,                           
    ymax = Co2PriceToCloseGap,                      
    fill = `Fuel Type`,  # Different colors for Fuel Types
    color = `Fuel Type`
  ),  linewidth = 0.02, alpha = 0.2) +  # Transparency for visibility
  scale_x_continuous(expand = c(0, 0), limits = c(0, 1.01 * max(data$share, na.rm = TRUE))) +
  scale_y_continuous(limits = c(-600, 1050)) +
  labs(x = "Share of road km in Country", y = "CO2 price to close total cost of ownership gap EUR/tCO2", color = "Fuel Type") +
  
  # Manually define colors for the Fuel Type categories
  scale_color_manual(values = c("BET Mid" = "#1F77B4", "BET Long" = "#9467BD", "CH2 FCET" = "#E65C00"),
                     breaks = c("CH2 FCET", "BET Long", "BET Mid")) +  # Reorder the legend items

  scale_fill_manual(values = c("BET Mid" = "#1F77B4", "BET Long" = "#9467BD", "CH2 FCET" = "#E65C00"),
                    breaks = c("CH2 FCET", "BET Long", "BET Mid")) +  # Reorder the legend items
  
  # Use guides to customize the legend
  guides(
    color = guide_legend(order = 1),  # Order of color legend
    fill = guide_legend(order = 1)    # Order of fill legend
  ) +
  
  # Your existing plot elements (e.g., vertical dashed lines, arrows, etc.)
 # geom_point(data = findZeroPoints, aes(x = share, y = 0), 
 #            shape = 1, size = 6, stroke = 2, fill = NA, color = "black") +
 # geom_vline(data = findZeroPoints, aes(xintercept = share, color = `Fuel Type`), 
 #            linetype = "dashed", linewidth = 1) +
 # geom_segment(data = findZeroPoints, aes(x = 0, xend = share, y = arrow_y, yend = arrow_y, color = `Fuel Type`), 
 #              arrow = arrow(length = unit(0.3, "cm"), type = "open"), 
 #              linewidth = 1) +
  geom_hline(yintercept = 0, color = "black", size = 0.8) +
  geom_hline(yintercept = co2PriceCurrentPol$value, color = "lightgreen", size = 2) +
  annotate("label", x = 5, y = co2PriceCurrentPol$value, label = "CO2 price\n Current Policies", 
           color = "black", fill = "white", fontface = "bold", size = 6, hjust = 0, vjust = -1, 
           label.padding = unit(0.3, "cm"), label.size = 0) +
 # Add facet for ACEscen with customizations
   # Use facet_grid2 with axes = "all" to show y-axis everywhere
  facet_grid2(
    cols = vars(Country),
    scales = "free_y",
    axes = "all"  # <- this makes all axes (x and y) visible
  ) +
  labs(title = paste("CO2 price needed to close total cost of ownership gap between ZET and conventional diesel trucks in 2030 for rather pessimistic cost developments"), 
        caption = paste("Figure 1| Total cost of ownership gap between ZET and conventional diesel trucks covering heterogenous cost and mileage profiles in key european truck markets and their respective share in the total road km\nfor rigid and tractor-trailer trucks.\na) Medium TCO cost projections for all technologies.\nb) Rather optimistic TCO projections for the zero-emission technology under consideration and rather pessimistic TCO cost projections for the compared conventional diesel truck.\nc) Rather pessimistic TCO projections for the zero-emission technology under consideration and rather optimisitc TCO cost projections for the compared conventional diesel truck.")) +
   theme(
    plot.title = element_text(size = 22, face = "bold", hjust = 0.5),
    plot.caption = element_text(size = 14, hjust = 0),
    axis.title.x = element_text(size = 18, margin = margin(t = 12)),
    axis.title.y = element_text(size = 18, margin = margin(r = 12)),
    axis.text = element_text(size = 14, color = "black"),
    axis.ticks = element_line(color = "black", size = 0.5),
    axis.line = element_line(color = "black", size = 0.8),
    
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 16),
    legend.position = "bottom",
    
    strip.text = element_text(
      size = 20,
      face = "bold",
      color = "black",
      margin = margin(t = 6, b = 6)  # Add breathing room
    ),
    strip.background = element_rect(
      fill = "#F5F5F5",  # Soft grey background, easy on the eyes
      color = NA         # No border
    ),
    panel.spacing = unit(1.2, "lines"),  # Extra space between facets
    
    
    panel.background = element_rect(fill = "white"),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "white")
  )
plot(p)
dir <- dirname(getwd())
ggsave(file.path(dir, "plots", paste0("CO2priceAMdistributionBarPlotEUR", unique(data$paperScen), ".svg")), plot = p, device = "svg", width = 27, height = 9, units = "in")


```

##test
```{r, fig.width=27, fig.height=12, fig.fullwidth=FALSE}
#version 2
library(dplyr)
yr <- c(2030)
trucktechs <- c("BET Long", "BET Mid", "CH2 FCET")
data <- copy(TCOdrivingProfiles)[period %in% yr & `Fuel Type` %in% trucktechs]
data[, cum_width := 0.999* (share - shift(share, type = "lag")), by = c("ACEAscen", "Fuel Type")]
data[is.na(cum_width), cum_width := (share), by = c("ACEAscen", "Fuel Type")]

# Cut highest and lowest data
data[TCOgap >= 0.7, TCOgap := 0.7]
data[TCOgap <= -0.9, TCOgap := -0.9]

findZeroPoints <-  data[ , .SD[which.min(abs(TCOgap))], by = .(period, `Fuel Type`, ACEAscen)]
setorder(findZeroPoints, ACEAscen, share)
findZeroPoints[, arrow_y := seq(-0.6, -0.9, length.out = .N), by = "ACEAscen"]

setorder(findZeroPoints, - share)
data[, `Fuel Type` := factor(`Fuel Type`, levels = unique(findZeroPoints$`Fuel Type`))]
findZeroPoints[, `Fuel Type` := factor(`Fuel Type`, levels = unique(findZeroPoints$`Fuel Type`))]  
middle_y <- findZeroPoints[round(nrow(findZeroPoints)/6), arrow_y]

# Create staircase data
stair_data <- data %>%
  mutate(x_start = share - cum_width,
         x_end = share) %>%
  select(x_start, x_end, y = TCOgap, `Fuel Type` = `Fuel Type`, ACEAscen)

# Combine x and y points for staircase lines
stair_lines <- stair_data %>%
  rowwise() %>%
  do(data.frame(
    x = c(.$x_start, .$x_end),
    y = c(.$y, .$y),
    `Fuel Type` = .$`Fuel Type`,
    ACEAscen = .$ACEAscen,
    group = paste(.$`Fuel Type`, .$y)
  )) %>%
  ungroup()
stair_lines_medium <- stair_lines %>%
  filter(ACEAscen == "a) Medium")
setnames(stair_lines_medium, "Fuel.Type", "Fuel Type")

# Create the bar plot
p <- ggplot(data[!ACEAscen == "a) Medium"]) +
 # geom_segment(aes(
 #   x = abs(share - cum_width),  # Bar starts left of cum_shareKmEUR
 #   xend = share,              # Bar ends at cum_shareKmEUR
 #   y = TCOgap,                           # Bars start from the x-axis
  #  yend = TCOgap,                      # Bar height is determined by TCOgap
  #  color = `Fuel Type`,
  #),  linewidth = 0.8) +
  geom_rect(aes(
    xmin = share - cum_width,  
    xmax = share,              
    ymin = 0,                           
    ymax = TCOgap,                      
    fill = ACEAscen,  # Different colors for Fuel Types
    color = ACEAscen
  ),  linewidth = 0.02, alpha = 0.2) +  # Transparency for visibility
  scale_x_continuous(expand = c(0, 0), limits = c(0, 1.05 * max(data$share, na.rm = TRUE))) +
  scale_y_continuous(limits = c(-1, 0.7)) +
  labs(x = "Share of road km in EUR", y = "TCO gap", color = "Fuel Type") +
  
  # Manually define colors for the Fuel Type categories
  scale_color_manual(values = c("a) Medium" = "#0a4c8f", "b) Rather optimistic" = "#5aad5c", "c) Rather pessimistic" = "#ad705a"))+
                     

  scale_fill_manual(values = c("a) Medium" = "#0a4c8f", "b) Rather optimistic" = "#5aad5c", "c) Rather pessimistic" = "#ad705a"))+
                    
  
  # Use guides to customize the legend
  guides(
    color = guide_legend(order = 1),  # Order of color legend
    fill = guide_legend(order = 1)    # Order of fill legend
  ) +
  
  # Your existing plot elements (e.g., vertical dashed lines, arrows, etc.)
  geom_point(data = findZeroPoints, aes(x = share, y = 0), 
             shape = 1, size = 6, stroke = 2, fill = NA, color = "black") +
  geom_vline(data = findZeroPoints, aes(xintercept = share, color = `Fuel Type`), 
             linetype = "dashed", linewidth = 1) +
  geom_segment(data = findZeroPoints, aes(x = 0, xend = share, y = arrow_y, yend = arrow_y, color = `Fuel Type`), 
               arrow = arrow(length = unit(0.3, "cm"), type = "open"), 
               linewidth = 1) +
 geom_label(data = findZeroPoints, 
           aes(x = 20, y = arrow_y, 
               label = paste("~", round(share), "%")),
           color = "black", 
           fill = "white",  # Set the background color to white
           size = 8,  # Consistent text size
           fontface = "bold",  # Make the text bold
           label.padding = unit(0.2, "cm"),  # Adjust padding for a clean look
           label.size = 0,  # No border around the label
           hjust = 0.5, 
           vjust = 0.5) +
  annotate("label", x = 27, y = middle_y, label = "of road km cost beneficial", 
           color = "black", fill = "white", fontface = "bold", size = 6, hjust = 0, vjust = 0.5, 
           label.padding = unit(0.3, "cm"), label.size = 0) +
  geom_hline(yintercept = 0, color = "black", size = 0.8) +
  geom_path(data = stair_lines_medium, aes(x = x, y = y, color = ACEAscen, group = group), linewidth = 2)+
  
 # Add facet for ACEscen with customizations
  facet_wrap(~ `Fuel Type`, ncol = 3, scales = "free_y") +  # Free y-axis for each facet
  labs(title = paste("Total cost of ownership gap between ZET and conventional diesel trucks"), 
        subtitle= paste(unique(data$paperScen), " case |", unique(data$period)),
        caption = paste("Figure 1| Total cost of ownership gap between ZET and conventional diesel trucks covering heterogenous cost and mileage profiles in key european truck markets and their respective share in the total road km\nfor rigid and tractor-trailer trucks.\na) Medium TCO cost projections for all technologies.\nb) Rather optimistic TCO projections for the zero-emission technology under consideration and rather pessimistic TCO cost projections for the compared conventional diesel truck.\nc) Rather pessimistic TCO projections for the zero-emission technology under consideration and rather optimisitc TCO cost projections for the compared conventional diesel truck.")) +
  theme(
    plot.subtitle = element_text(size = 18, face = "italic", hjust = 0.5),
    plot.caption = element_text(size = 18, face = "italic", hjust = 0),
    axis.title.x = element_text(size = 18, margin = margin(t = 10)),
    axis.title.y = element_text(size = 18, margin = margin(r = 10)),
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 18),
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
    panel.background = element_rect(fill = "white"),   # White background
    panel.grid.major = element_blank(),                # Remove major grid lines
    panel.grid.minor = element_blank(),                # Remove minor grid lines
    axis.line = element_blank(),  # Remove all axis lines
    axis.line.x = element_line(color = "black", size = 0.8),
    axis.line.y = element_line(color = "black", size = 0.8),
    axis.ticks = element_line(color = "black", size = 0.5), # Visible axis ticks
    axis.text = element_text(color = "black", size = 16),  # Visible axis markers
    plot.background = element_rect(fill = "white"),      # White plot background
    
    # Facet header customizations
    strip.text = element_text(size = 20, face = "bold", color = "black"),  # Larger, bold, black facet labels
    strip.background = element_rect(fill = "white")  # Remove background color from facet headers
  )

plot(p)
dir <- dirname(getwd())
ggsave(file.path(dir, "plots", paste0("AMdistributionBarPlotEUR", unique(data$paperScen), ".svg")), plot = p, device = "svg", width = 27, height = 9, units = "in")

```
