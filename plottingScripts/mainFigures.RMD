---
title: "Main figures"
author: "Johanna Hoppe"
date: "2025-02-03"
output: html_document
---

```{r setup, include=FALSE}
## Always run first chunk
knitr::opts_chunk$set(echo = FALSE)#
library(ggplot2)
library(data.table)
library(colorspace)
library(ggtext)
library(ggh4x)
library(ggforce)
library(patchwork)
library(scales)
library(cowplot)
library(funkyheatmap)
library(stringr)
library(grid)
library(tibble)

rm(list=ls())
mainFolder <- dirname(this.path::this.dir())
dataFolder <-  file.path(mainFolder, "data")
plotFolder <- file.path(mainFolder, "plots", "main")
source(file.path(mainFolder, "plottingScripts", "functions.R"))
source(file.path(mainFolder, "plottingScripts", "plotFunctions.R"))
source(file.path(mainFolder, "plottingScripts", "plotSettings.R"))

annualMileage <- data.table(truckClass = c("Rigid", "Rigid", "Rigid", "Tractor-trailer", "Tractor-trailer", "Tractor-trailer"),
                            operation = c("Urban", "Regional", "Long-haul", "Urban", "Regional", "Long-haul"),
                            am = c(30000, 85000, 140000, 40000, 90000, 160000))

DCOscenarios <- tribble(
  ~truckTech,         ~truckTCOscenario, ~counterTech, ~counterTechTCOscenario, ~DCOscenario,
  "BET small battery", "LC_HTMxPROG",    "ICET",       "HC_LTMxBAU",            "Optimistic",
  "BET large battery", "LC_HTMxPROG",    "ICET",       "HC_LTMxBAU",            "Optimistic",
  "FCET",              "LC_HTMxPROG",    "ICET",       "HC_LTMxBAU",            "Optimistic",
  "BET small battery", "MC_MTMxBAU",     "ICET",       "MC_MTMxBAU",            "Medium",
  "BET large battery", "MC_MTMxBAU",     "ICET",       "MC_MTMxBAU",            "Medium",
  "FCET",              "MC_MTMxBAU",     "ICET",       "MC_MTMxBAU",            "Medium",
  "BET small battery", "HC_LTMxBAU",     "ICET",       "LC_HTMxPROG",           "Pessimistic",
  "BET large battery", "HC_LTMxBAU",     "ICET",       "LC_HTMxPROG",           "Pessimistic",
  "FCET",              "HC_LTMxBAU",     "ICET",       "LC_HTMxPROG",           "Pessimistic"
)
setDT(DCOscenarios)
```


# Fig1:  Exemplary DCO across utilisation profiles and vehicle-parameter/energy-carrier scenarios.
## Scenario overview
```{r, fig.width=4, fig.height=2.2, fig.fullwidth=FALSE}
scenariosPlot <- scenOverview(baseZise, paperColors, baseTextSize)
```
## Visualization utilization profiles
```{r, fig.width=3, fig.height=2.2, fig.fullwidth=FALSE}
#load data
reducedBinnedWeightedMileage <- prepareMileageData(dataFolder, bin = TRUE, reduce = TRUE)
exampleCountry <- "DE" 

utilizationExample <- examplaryUtilisation(exampleCountry, reducedBinnedWeightedMileage, baseTextSize)
```
## Exemplary DCO barplot
```{r, fig.width=7.05, fig.height=3.5, fig.fullwidth=FALSE}
#select data
paperScenario <- "Current policies"  
yr <- c(2030)
vehSize <- "Tractor-trailer"
modeOfoperation <- "Long-haul"
am <- annualMileage[truckClass == vehSize & operation == modeOfoperation]$am
exampleCountry <- "DE" 
#load data
TCOdata <- loadTCO(dataFolder)
TCO <- applyMileage(am, TCOdata)
TCO <- groupParameters(TCO)

TCOtoDCOexample <- dcoBarPlot(TCO, DCOscenarios, yr, vehSize, exampleCountry, paperScenario, baseTextSize)
```
## Panel
```{r, fig.width=7.09, fig.height=6.2, fig.fullwidth=FALSE}
gScenarios <- ggplotGrob(scenariosPlot)

row1 <- plot_grid(
  utilizationExample, gScenarios,
  ncol = 2,
  rel_widths = c(3, 3.5)
)

row2 <- plot_grid(
  TCOtoDCOexample,
  ncol = 1
)

whiteSpace <- ggdraw() + theme_void() + 
  theme(plot.background = element_rect(fill = "white", color = NA))

introPanel <- plot_grid(
  whiteSpace,
  row1,
  whiteSpace,
  row2,
  whiteSpace,
  ncol = 1,
  rel_heights = c(0.16, 1.9, 0.16, 3, 0.05)
)
xMiddle <- 0.485
triangleWidth  <- 0.06      
triangleHeight <- 0.017      
triangleY <- 8.3 / 13

# Create the triangle grob
triangleGrob <- polygonGrob(
  x = c(xMiddle - triangleWidth / 2, xMiddle + triangleWidth / 2, xMiddle),
  y = c(triangleY, triangleY, triangleY - triangleHeight),
  gp = gpar(fill = "black", col = NA, alpha = 0.3)
)

annotatedPanel <- ggdraw(introPanel) +
  draw_label(
    "Ã—",
    x = xMiddle,
    y = 10 / 13,
    size = 20,
    fontface = "bold",
    color = "black",
    alpha = 0.3
  ) +
  draw_grob(triangleGrob) +
  draw_plot_label(
    label = c("a", "b", "c"),
    x = c(0, xMiddle - 0.025, 0),       
    y = c(1, 1, 0.585 + 0.005),           
    hjust = 0, vjust = 1,
    size = baseTextSize *1.2,
    fontface = "bold",
    color = "black"
  ) +
  draw_plot_label(
    label = c(
      "Country- and truck type specific\nutilisaton profiles",
      "Scenario based approach",
      "Country- and truck type specific differential cost of ownership (DCO)"
    ),
    x = c(0.03, xMiddle, 0.03),
    y = c(0.995, 0.995, 0.585),
    hjust = 0, vjust = 1,
    size = baseTextSize * 1.2,
    fontface = "plain",
    color = "black"
  )

annotatedPanel

ggsave(
  filename = file.path(plotFolder, paste0("introPanel.pdf")),
  plot = annotatedPanel,
  width = 7.1,
  height = 7.4,
  units = "in",
  device = cairo_pdf
)

```

# Fig 2: Economically viable road freight activity for the optimistic, medium, and pessimistic DCO scenario
## Heterogeneous DCO in 2030 in descending order and their cumulative share in total annual road freight activity in the considered markets. 
## Evolution of the cumulative share of economically viable road freight activity over time.
```{r, fig.width= 5, fig.height= 8.5, fig.fullwidth=FALSE}
yr <- c(2030)
paperScenario <- "Current policies"

TCOdata <- loadTCO(dataFolder)
mileageDistribution <- prepareMileageData(dataFolder)
DCOdata <- getDCO(DCOscenarios, TCOdata)
setnames(mileageDistribution, "binMean", "annualM")
DCOmilageDistribution <- applyMileage(mileageDistribution, DCOdata)
DCOmilageDistributionShares <- calculateFreightActivityShares(DCOmilageDistribution, focus = "EUR")

TCOxAnnualMileage <- amDistributionBarPlot(DCOmilageDistributionShares, yr, paperScenario)

MetaTCOxAnnualMileage <- metaPlot(DCOmilageDistributionShares[period < 2041], paperScenario)

```
## Combine meta and mileage dstribution plot
```{r, fig.width=4.5, fig.height=5, fig.fullwidth=FALSE}
legend <- get_legend(
  TCOxAnnualMileage +
    theme(
      legend.position = "bottom",
      legend.justification = "left",   # start from left in its own box
      legend.box.just = "left"
    )
)

# 2. Remove legends from the plots
TCOxAnnualMileagePlot_noleg <- TCOxAnnualMileage + theme(legend.position = "none")
metaPlot_noleg <- MetaTCOxAnnualMileage + theme(legend.position = "none")

# 3. Combine the plots side by side
combined <- plot_grid(
  TCOxAnnualMileagePlot_noleg,
  metaPlot_noleg,
  ncol = 2,
  rel_widths = c(1.2, 0.8),
  align = "v",
  labels = c("a", "b"),
  label_size = baseTextSize,
  label_fontface = "bold",
  label_x = 0.02,
  label_y = 1.02,
  hjust = 0, vjust = 1
) +
  theme(plot.margin = margin(t = 8, r = 3, b = 3, l = 10))

# 4. Shift legend slightly to the right using a spacer
legend_shifted <- plot_grid(
  NULL,      # empty spacer
  legend,
  ncol = 2,
  rel_widths = c(0.05, 0.3)  # First number: empty space on the left.Second number:space the legend occupies.
)

# 5. Combine plots and shifted legend vertically
finalPlot <- plot_grid(
  combined,
  legend_shifted,
  ncol = 1,
  rel_heights = c(1, 0.05)  
)
plotWithLabels <- ggdraw(finalPlot) +
  draw_label(
    "Optimistic", x = 0.02, y = 0.76, angle = 90,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1.2,
    hjust = 0
  ) +
  draw_label(
    "Medium", x = 0.02, y = 0.5, angle = 90,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1.2,
    hjust = 0
  ) +
  draw_label(
    "Pessimistic", x = 0.02, y = 0.185, angle = 90,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1.2,
    hjust = 0
  )


# 6. Display final plot
plot(plotWithLabels)

ggsave(
  filename = file.path(plotFolder, paste0("EconomicallyViableActivity.pdf")),
  plot     = plotWithLabels,
  device   = cairo_pdf,
  width    = 4.5,          
  height   = 5,          
  units    = "in",
  dpi      = 300           
)
```

# Fig 3: Feasible HDV road freight activity
## Cumulative fraction of maximum daily vehicle kilometers
## Max daily milage x share of road km  
```{r, fig.width=4.5, fig.height=1.8, fig.fullwidth=FALSE}
vehType <- "Tractor-trailer"

weightedMileage <- prepareMileageData(dataFolder, bin = TRUE, reduce = FALSE)
infrastructure <- loadInfrastructureBuildUp(dataFolder)
rangeAnalysis <- getRangeAnalysis(weightedMileage, infrastructure)
ranges <- loadRanges(dataFolder)

dMaxDensityPlot <- plotMileageDensity(weightedMileage)
rangePlot <- plotRangeAnalysis(rangeAnalysis, ranges, infrastructure)


combined <- plot_grid(
    dMaxDensityPlot,
    rangePlot,
    ncol = 2,
    rel_widths = c(2.35, 8),
    labels = c("a", "b"),
    label_size = baseTextSize,
    label_fontface = "bold",
    label_x = 0.02,
    label_y = 1.02,
    hjust = 0, vjust = 1
  ) +
  theme(plot.margin = margin(t = 15, r = 5, b = 5, l = 12))

plot(combined)


ggsave(
  filename = file.path(plotFolder, paste0("rangeAnalysis.pdf")),
  plot     = combined,
  device   = cairo_pdf,
  width    = 4.5,          
  height   = 1.8,          
  units    = "in",
  dpi      = 300           
)

```

# Fig 4: Heterogeneous DCO of BETs against ICETs for feasible maximum daily mileages
```{r, fig.width= 5, fig.height= 3, fig.fullwidth=FALSE}
TCOdata <- loadTCO(dataFolder)
binnedWeightedMileage <- prepareMileageData(dataFolder, bin = TRUE, reduce = FALSE)
reducedBinnedWeightedMileage <- prepareMileageData(dataFolder, bin = TRUE, reduce = TRUE)
ranges <- loadRanges(dataFolder)
infrastructure <- loadInfrastructureBuildUp(dataFolder)
dco <- getDCO(DCOscenarios, TCOdata)
setnames(reducedBinnedWeightedMileage, "binMean", "annualM")
DCOmilageDistribution <- applyMileage(reducedBinnedWeightedMileage, dco)
DCOmilageDistributionShares <- calculateFreightActivityShares(DCOmilageDistribution, focus = "EUR")
feasDCO <- checkFeasMileageDistribution(DCOmilageDistribution, binnedWeightedMileage, reducedBinnedWeightedMileage, ranges, infrastructure, focus = "EUR")

paperScenario <- "Current policies"
DCOscen <- "Medium"
FeasTCOxAnnualMileage1 <- amDistributionBarPlot(feasDCO[DCOscenario == DCOscen], yr = 2030, paperScenario, feas = TRUE)
FeasTCOxAnnualMileage2<- amDistributionBarPlot(feasDCO[DCOscenario == DCOscen], yr = 2035, paperScenario, feas = TRUE)

legend <- get_legend(
  FeasTCOxAnnualMileage1 +
    theme(
      legend.position = "bottom",
      legend.justification = "left",   
      legend.box.just = "left"
    )
)

# 2. Remove legends from the plots
FeasTCOxAnnualMileage1_noleg <- FeasTCOxAnnualMileage1 + theme(legend.position = "none")
FeasTCOxAnnualMileage2040_noleg <- FeasTCOxAnnualMileage2+ theme(legend.position = "none")

# 3. Combine the plots side by side
combined <- plot_grid(
  FeasTCOxAnnualMileage1_noleg,
  FeasTCOxAnnualMileage2040_noleg,
  ncol = 2,
  rel_widths = c(1, 1),
  align = "h",
  labels = c("a", "b"),
  label_size = baseTextSize,
  label_fontface = "bold",
  label_x = 0.02,
  label_y = 1.02,
  hjust = 0, vjust = 1
) +
  theme(plot.margin = margin(t = 12, r = 5, b = 5, l = 12))

# 4. Shift legend slightly to the right using a spacer
legend_shifted <- plot_grid(
  NULL,      # empty spacer
  legend,
  ncol = 2,
  rel_widths = c(0.05, 0.3)  # First number: empty space on the left.Second number:space the legend occupies.
)

# 5. Combine plots and shifted legend vertically
finalPlot <- plot_grid(
  combined,
  legend_shifted,
  ncol = 1,
  rel_heights = c(1, 0.08)  
)
plotWithLabels <- ggdraw(finalPlot) +
  draw_label(
    DCOscen, x = 0.02, y = 0.45, angle = 90,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1.2,
    hjust = 0
  ) 


# 6. Display final plot
plot(plotWithLabels)

ggsave(
  filename = file.path(plotFolder, paste0("FeasibleEconomicallyViableActivity.pdf")),
  plot     = plotWithLabels,
  device   = cairo_pdf,
  width    = 4.5,          
  height   = 6.2/3,          
  units    = "in",
  dpi      = 300           
)


```

# Fig. 5: Comparison of CAPEX and OPEX of BETs/FCETs relative to ICETs
```{r, fig.width=7.09, fig.height=3.5, fig.fullwidth=FALSE}

scenario <- "Current policies"
vehType <- "Tractor-trailer"
TCOdata <- loadTCO(dataFolder)
region <- "EUR"
DCO <- getDCO(DCOscenarios, TCOdata, keep = TRUE)
breakeven <- caluclateAnnualMileageBreakeven(DCO)
syntheticalBreakeven <- caluclateSyntheticalBreakeven()
capexVsOpex <- capexVsOpexOverviewPlot(DCO, breakeven, syntheticalBreakeven, scenario, vehType, region)

plot(capexVsOpex)

ggsave(
  filename = file.path(plotFolder, paste0("CAPEvsOPEX.pdf")),
  plot     = capexVsOpex,
  device   = cairo_pdf,
  width    = 7.09,          
  height   = 3.5,          
  units    = "in",
  dpi      = 300           
)

```

# Fig. 6: Evolution of the cumulative share of economically viable road freight activity over time. Results are shown for th ecurrent-policies case and for a counterfactual scenario in which ZET road-toll reductions, carbon pricing, fuel mandates, and hydrogen tax exemptions are removed
```{r, fig.width= 4.5, fig.height= 2.3, fig.fullwidth=FALSE}
paperScenario <- c("Current policies", "Removed policies")

TCOdata <- loadTCO(dataFolder)
mileageDistribution <- prepareMileageData(dataFolder)
DCOdata <- getDCO(DCOscenarios, TCOdata)
setnames(mileageDistribution, "binMean", "annualM")
DCOmilageDistribution <- applyMileage(mileageDistribution, DCOdata)
DCOmilageDistributionShares <- calculateFreightActivityShares(DCOmilageDistribution, focus = "EUR")

  data <- copy(DCOmilageDistributionShares)[paperScen %in% paperScenario & period < 2041]
  findZeroPoints <- data[ , .SD[which.min(abs(value))], by = .(period, truckTechnology, paperScen, DCOscenario)][
    , .(period, `truckTechnology`, paperScen, DCOscenario, cumBinWeightedShareEUR)
  ]
  findZeroPoints[, DCOscenario := factor(DCOscenario, levels = c("Optimistic", "Medium", "Pessimistic"))]
  
  arrow <- copy(findZeroPoints)
  arrow <- dcast(arrow, period + truckTechnology + DCOscenario ~ paperScen, value.var = "cumBinWeightedShareEUR")
  arrow <- arrow[
  , .(period, truckTechnology, DCOscenario,
      current = `Current policies`,
      removed = `Removed policies`)
]
  
  p1 <- ggplot(findZeroPoints[DCOscenario == "Optimistic"], 
               aes(x = period, y = cumBinWeightedShareEUR * 100, color = truckTechnology, linetype = paperScen)) +
    geom_line(linewidth = baseLineWidth) +
    scale_color_manual(values = paperColors, guide = "none") +  # legend removed
    scale_linetype_manual(values = paperLines, guide = "none") +
    labs(y = "Economically viable\nactivity [%]", x = NULL) +
    scale_x_continuous(breaks = seq(min(findZeroPoints$period),
                                    max(findZeroPoints$period), by = 5)) +
    scale_y_continuous(limits = c(0, 102)) +
    plotTheme(baseTextSize) +
    theme(legend.position = "bottom",
          legend.box = "horizontal",
          legend.direction = "vertical")
  
  p2 <- ggplot(findZeroPoints[DCOscenario == "Medium"]) +
    geom_line(aes(x = period, y = cumBinWeightedShareEUR * 100, color = truckTechnology, linetype = paperScen),
              linewidth = baseLineWidth) +
    geom_segment(
      data = arrow[DCOscenario == "Medium" & truckTechnology == "BET small battery"],
      aes(x = period, xend = period,
          y = removed* 100, yend = current* 100 *0.995),
          color = "#17BECF",
          linewidth = baseLineWidth * 1.5,
          arrow = arrow(
            type = "closed",                 
            length = unit(0.07, "cm"),       
            angle = 35)) +
    scale_color_manual(values = paperColors) +  
    scale_linetype_manual(values = paperLines) +
    scale_x_continuous(breaks = seq(min(findZeroPoints$period),
                                    max(findZeroPoints$period), by = 5)) +
    scale_y_continuous(limits = c(0, 102)) +
    labs(
      x = "Year",
      y = NULL,
      color = "Truck technology",
      linetype = ""
    ) +
    plotTheme(baseTextSize) +
    theme(legend.position = "bottom",
          legend.box = "horizontal",
          legend.direction = "vertical")
  
  p3 <- ggplot(findZeroPoints[DCOscenario == "Pessimistic"], 
               aes(x = period, y = cumBinWeightedShareEUR * 100, color = truckTechnology, linetype = paperScen)) +
    geom_line(linewidth = baseLineWidth) +
    scale_color_manual(values = paperColors, guide = "none") +  # legend removed
    scale_linetype_manual(values = paperLines, guide = "none") +
    labs(x = NULL, y = NULL) +
    scale_x_continuous(breaks = seq(min(findZeroPoints$period),
                                    max(findZeroPoints$period), by = 5)) +
    scale_y_continuous(limits = c(0, 102)) +
    plotTheme(baseTextSize) +
    theme(legend.position = "bottom",
          legend.box = "horizontal",
          legend.direction = "vertical")
  
  combined <- (
    (p1 | p2 | p3) +
      plot_layout(widths = c(0.8, 0.8, 0.8), guides = "collect") &
      theme(
        legend.position = "bottom",
        plot.margin   =  margin(t = 10, r = 3, b = 3, l = 3)
      ))

    
plotWithLabels <- ggdraw(combined) +
  draw_label(
    "Optimistic", x = 0.19, y = 0.93, angle = 0,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1,
    hjust = 0
  ) +
  draw_label(
    "Medium", x = 0.5, y = 0.93, angle = 0,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1,
    hjust = 0
  ) +
  draw_label(
    "Pessimistic", x = 0.8, y = 0.93, angle = 0,
    fontface = "bold",
    fontfamily = "sans",
    size = baseTextSize * 1,
    hjust = 0
  )


# 6. Display final plot
plot(plotWithLabels)

ggsave(
  filename = file.path(plotFolder, paste0("removedPolicies.pdf")),
  plot     = plotWithLabels,
  device   = cairo_pdf,
  width    = 4.5,         
  height   = 2.3,          
  units    = "in",
  dpi      = 300          
)
```

